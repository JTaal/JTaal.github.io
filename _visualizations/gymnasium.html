<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gymnasium Web Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Custom scrollbar for the training log */
        #trainingLog::-webkit-scrollbar {
            width: 8px;
        }
        #trainingLog::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        #trainingLog::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        #trainingLog::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen py-8">

    <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl mx-4">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-100">Gymnasium Web Interface</h1>
            <p class="text-gray-400 mt-2">Interact with your live Gymnasium API environment.</p>
            <a href="https://docs.cleanrl.dev/rl-algorithms/sac/#sac_continuous_actionpy" target="_blank" class="text-blue-400 hover:text-blue-300 transition-colors text-sm mt-1 inline-block">SAC Python Implementation Docs</a>
        </header>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <select id="envIdSelect" class="md:col-span-2 w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <optgroup label="Classic Control">
                    <option value="CartPole-v1">CartPole-v1 (Discrete)</option>
                    <option value="MountainCar-v0">MountainCar-v0 (Discrete)</option>
                    <option value="Acrobot-v1">Acrobot-v1 (Discrete)</option>
                    <option value="Pendulum-v1">Pendulum-v1 (Continuous)</option>
                </optgroup>
                <optgroup label="MuJoCo">
                    <option value="Hopper-v4">Hopper-v4 (Continuous)</option>
                    <option value="Walker2d-v4">Walker2d-v4 (Continuous)</option>
                    <option value="HalfCheetah-v4">HalfCheetah-v4 (Continuous)</option>
                    <option value="Ant-v4">Ant-v4 (Continuous)</option>
                </optgroup>
                 <optgroup label="Box2D">
                    <option value="LunarLander-v2">LunarLander-v2 (Discrete)</option>
                    <option value="LunarLanderContinuous-v2">LunarLander-v2 (Continuous)</option>
                    <option value="BipedalWalker-v3">BipedalWalker-v3 (Continuous)</option>
                    <option value="CarRacing-v2">CarRacing-v2 (Continuous)</option>
                </optgroup>
            </select>
            <button id="resetBtn" class="w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors">
                Start Environment
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Manual Control -->
            <div class="flex flex-col">
                <main class="text-center">
                    <div class="bg-gray-900 rounded-lg p-2 mb-4 inline-block shadow-inner">
                         <img id="frameDisplay" src="https://placehold.co/600x400/1f2937/d1d5db?text=Environment+View" alt="Gymnasium Environment Frame" class="rounded-md w-full max-w-xl mx-auto">
                    </div>
                    <div id="actionButtons" class="flex justify-center gap-4 mb-6">
                        <button onclick="stepEnv(0)" class="action-btn px-8 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors btn-disabled" disabled>
                            Action 0
                        </button>
                        <button onclick="stepEnv(1)" class="action-btn px-8 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors btn-disabled" disabled>
                            Action 1
                        </button>
                    </div>
                </main>
                <footer class="bg-gray-900/50 p-4 rounded-lg shadow-inner text-sm text-gray-400 mt-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div><strong class="text-gray-300">Session ID:</strong> <span id="sessionIdDisplay" class="font-mono bg-gray-700 text-gray-300 px-2 py-1 rounded">N/A</span></div>
                        <div><strong class="text-gray-300">Last Reward:</strong> <span id="rewardDisplay" class="font-mono bg-gray-700 text-gray-300 px-2 py-1 rounded">N/A</span></div>
                        <div><strong class="text-gray-300">Status:</strong> <span id="statusDisplay" class="font-mono bg-gray-700 text-gray-300 px-2 py-1 rounded">Inactive</span></div>
                    </div>
                </footer>
            </div>

            <!-- Right Column: Live Training -->
            <div class="flex flex-col bg-gray-900/50 p-4 rounded-lg shadow-inner">
                <h2 class="text-xl font-bold text-gray-100 text-center mb-4">Live Agent Training</h2>
                <button id="trainBtn" class="w-full px-6 py-2 mb-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors btn-disabled" disabled>
                    Train Random Agent
                </button>
                <div class="bg-gray-900 rounded-lg p-3 text-left flex-grow h-64 min-h-[200px]">
                    <p class="text-gray-400 text-xs mb-2 text-center">Note: This is a placeholder using a random agent. A full SAC conversion is a major project.</p>
                    <div id="trainingLog" class="h-full overflow-y-auto text-sm font-mono text-gray-300">
                        <p class="text-gray-500">Training log will appear here...</p>
                    </div>
                </div>
                 <div class="text-center mt-4 text-gray-400 text-sm">
                    <strong>Total Reward:</strong> <span id="totalRewardDisplay" class="font-mono bg-gray-700 text-gray-300 px-2 py-1 rounded">0</span>
                </div>
            </div>
        </div>
        <div id="errorMessage" class="text-center text-red-400 mt-6 font-semibold"></div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        let sessionId = null;
        let isTraining = false;
        let actionSpaceInfo = null;
        let totalReward = 0;
        const apiUrl = 'https://jtaal.pythonanywhere.com/gym';

        // --- DOM ELEMENTS ---
        const resetBtn = document.getElementById('resetBtn');
        const trainBtn = document.getElementById('trainBtn');
        const envIdSelect = document.getElementById('envIdSelect');
        const frameDisplay = document.getElementById('frameDisplay');
        const sessionIdDisplay = document.getElementById('sessionIdDisplay');
        const rewardDisplay = document.getElementById('rewardDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const totalRewardDisplay = document.getElementById('totalRewardDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const trainingLog = document.getElementById('trainingLog');
        const actionButtons = document.getElementById('actionButtons');

        // --- EVENT LISTENERS ---
        resetBtn.addEventListener('click', () => resetEnv(true));
        trainBtn.addEventListener('click', toggleTraining);

        // --- UI UPDATE FUNCTIONS ---
        function setLoadingState(isLoading) {
            resetBtn.disabled = isLoading;
            resetBtn.textContent = isLoading ? 'Loading...' : 'Start Environment';
            resetBtn.classList.toggle('btn-disabled', isLoading);
            if(isLoading) errorMessage.textContent = '';
        }

        function setActionButtonsState(spaceInfo) {
            actionButtons.innerHTML = ''; // Clear existing buttons
            if (!spaceInfo) {
                trainBtn.disabled = true;
                trainBtn.classList.add('btn-disabled');
                return;
            }

            trainBtn.disabled = false;
            trainBtn.classList.remove('btn-disabled');

            if (spaceInfo.type === 'Discrete') {
                for (let i = 0; i < spaceInfo.n; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = `Action ${i}`;
                    btn.onclick = () => stepEnv(i);
                    btn.className = 'action-btn px-6 py-2 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors';
                    actionButtons.appendChild(btn);
                }
            } else if (spaceInfo.type === 'Box') {
                const p = document.createElement('p');
                p.textContent = `Continuous Actions: Shape(${spaceInfo.shape.join(', ')})`;
                p.className = 'text-gray-400';
                actionButtons.appendChild(p);
            }
        }

        function logMessage(message, color = 'text-gray-300') {
            const p = document.createElement('p');
            p.textContent = `> ${message}`;
            p.className = color;
            trainingLog.appendChild(p);
            trainingLog.scrollTop = trainingLog.scrollHeight;
        }

        // --- API & LOGIC FUNCTIONS ---
        async function apiCall(body) {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        async function resetEnv(isManualReset = false) {
            if (isTraining && isManualReset) return;
            setLoadingState(true);
            setActionButtonsState(null);
            sessionId = null;
            totalReward = 0;
            totalRewardDisplay.textContent = '0';
            if (isManualReset) trainingLog.innerHTML = '';

            try {
                const envId = envIdSelect.value;
                logMessage(`Resetting environment: ${envId}`, 'text-yellow-400');
                const data = await apiCall({ action: 'reset', env_id: envId });
                sessionId = data.session_id;

                sessionIdDisplay.textContent = sessionId.substring(0, 8) + '...';
                statusDisplay.textContent = 'Ready';
                rewardDisplay.textContent = '0';
                
                const infoData = await apiCall({ action: 'get_info', session_id: sessionId });
                actionSpaceInfo = infoData.action_space;
                setActionButtonsState(actionSpaceInfo);

                // Perform a neutral step to get the first frame
                const stepData = await apiCall({ action: 'step', session_id: sessionId, step_action: 0 });
                frameDisplay.src = stepData.frame;
                logMessage('Environment ready.', 'text-green-400');
                return true; // Success
            } catch (error) {
                handleApiError(error);
                return false; // Failure
            } finally {
                setLoadingState(false);
            }
        }

        async function stepEnv(stepAction) {
             if (!sessionId) {
                errorMessage.textContent = 'No active session. Please start an environment first.';
                return null;
            }
            errorMessage.textContent = '';

            try {
                const data = await apiCall({
                    action: 'step',
                    session_id: sessionId,
                    step_action: stepAction
                });
                
                frameDisplay.src = data.frame;
                rewardDisplay.textContent = data.reward.toFixed(4);
                totalReward += data.reward;
                totalRewardDisplay.textContent = totalReward.toFixed(4);

                if (data.terminated || data.truncated) {
                    const reason = data.terminated ? 'Terminated' : 'Truncated';
                    statusDisplay.textContent = reason;
                    logMessage(`Episode finished: ${reason}. Total Reward: ${totalReward.toFixed(4)}`, 'text-yellow-400');
                    setActionButtonsState(null);
                    sessionId = null;
                } else {
                    statusDisplay.textContent = 'Running';
                }
                return data;
            } catch (error) {
                handleApiError(error);
                return null;
            }
        }

        function handleApiError(error) {
            let message = `Error: ${error.message}`;
            if (error instanceof TypeError && error.message === 'Failed to fetch') {
                message += '. This is likely a CORS issue or network problem.';
            }
            errorMessage.textContent = message;
            console.error('Fetch error:', error);
            
            sessionIdDisplay.textContent = 'N/A';
            statusDisplay.textContent = 'Error';
            frameDisplay.src = 'https://placehold.co/600x400/7f1d1d/fecaca?text=Error';
            if(isTraining) toggleTraining();
        }

        // --- TRAINING LOOP ---
        async function toggleTraining() {
            isTraining = !isTraining;
            trainBtn.textContent = isTraining ? 'Stop Training' : 'Train Random Agent';
            trainBtn.classList.toggle('bg-red-600', isTraining);
            trainBtn.classList.toggle('hover:bg-red-700', isTraining);
            trainBtn.classList.toggle('bg-green-600', !isTraining);
            trainBtn.classList.toggle('hover:bg-green-700', !isTraining);

            if (isTraining) {
                trainingLog.innerHTML = '';
                logMessage('Starting training with random agent...');
                trainingLoop();
            } else {
                logMessage('Training stopped by user.', 'text-red-400');
            }
        }

        function getRandomAction() {
            if (!actionSpaceInfo) return 0;
            if (actionSpaceInfo.type === 'Discrete') {
                return Math.floor(Math.random() * actionSpaceInfo.n);
            }
            if (actionSpaceInfo.type === 'Box') {
                const action = [];
                for (let i = 0; i < actionSpaceInfo.shape[0]; i++) {
                    const low = actionSpaceInfo.low[i];
                    const high = actionSpaceInfo.high[i];
                    action.push(Math.random() * (high - low) + low);
                }
                return action;
            }
            return 0;
        }

        async function trainingLoop() {
            if (!isTraining) return;

            if (!sessionId) {
                const success = await resetEnv();
                if (!success) {
                    toggleTraining(); // Stop if reset fails
                    return;
                }
            }

            const action = getRandomAction();
            const result = await stepEnv(action);

            if(result) {
                 // Add a small delay to make the visualization watchable
                setTimeout(trainingLoop, 100);
            } else {
                 // An error occurred in stepEnv, stop training
                if (isTraining) toggleTraining();
            }
        }

        // --- INITIALIZATION ---
        setActionButtonsState(null);
    </script>
</body>
</html>

