<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutionary Algorithm 3D Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e7eb; overflow: hidden; }
        #container, #labels { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #container { pointer-events: auto; }
        #labels { pointer-events: none; z-index: 2; }
        .panel { background-color: rgba(17, 24, 39, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(55, 65, 81, 0.5); z-index: 10; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        .toggle-btn { background-color: rgba(31, 41, 55, 0.8); border: 1px solid rgba(55, 65, 81, 0.5); }
        .toggle-btn.active { background-color: #2563eb; border-color: rgba(59, 130, 246, 0.7); color: #ffffff; }
        select { background-color: #374151; border: 1px solid #4b5563; }
        #panel-content { transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out; max-height: 500px; opacity: 1; overflow: hidden; margin-top: 1rem; padding-bottom: 0.5rem;}
        #ui-panel.collapsed #panel-content { max-height: 0; opacity: 0; margin-top: 0; padding-bottom: 0; }
        #collapse-btn svg { transition: transform 0.3s ease-in-out; }
        #ui-panel.collapsed #collapse-btn svg { transform: rotate(180deg); }
        .summary-btn { background-color: rgba(55, 65, 81, 0.7); border-radius: 50%; padding: 4px; }
        .summary-btn:hover { background-color: rgba(75, 85, 99, 0.9); }
        .settings-section-header { border-bottom: 1px solid rgba(55, 65, 81, 0.8); padding-bottom: 0.5rem; margin-bottom: 0.75rem; font-weight: 600; color: #9ca3af; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="m-0 p-0">
    <div id="container"></div>
    <div id="labels"></div>

    <!-- Top Control Bar -->
    <div id="top-bar" class="panel absolute top-4 left-1/2 -translate-x-1/2 p-2 rounded-lg shadow-2xl flex items-center gap-2 md:gap-4 flex-wrap justify-center">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-400">Landscape:</span>
            <select id="landscape-selector" class="rounded-md text-sm p-1">
                <option value="sphere">ðŸŸ¢ Sphere (Easy)</option>
                <option value="ackley">ðŸŸ¡ Ackley (Medium)</option>
                <option value="himmelblau">ðŸŸ¡ Himmelblau's (Medium)</option>
                <option value="rastrigin">ðŸ”´ Rastrigin (Hard)</option>
                <option value="rosenbrock">ðŸ”´ Rosenbrock (Hard)</option>
            </select>
        </div>
        <div class="border-l border-gray-600 h-8 hidden md:block"></div>
        <div class="flex items-center gap-2">
            <div id="algo-category-selector" class="flex gap-1 bg-gray-900/50 rounded-md p-1">
                <button data-category="GA" class="toggle-btn px-3 py-1 text-sm font-medium rounded-md transition-colors">GA</button>
                <button data-category="ES" class="toggle-btn px-3 py-1 text-sm font-medium rounded-md transition-colors">ES</button>
            </div>
            <select id="ga-algo-selector" class="rounded-md text-sm p-1">
                <option value="ga">Standard GA</option>
                <option value="de">Differential Evolution</option>
                <option value="pso">Particle Swarm (PSO)</option>
            </select>
            <select id="es-algo-selector" class="rounded-md text-sm p-1 hidden">
                <option value="es">Standard ES</option>
                <option value="cma-es">CMA-ES</option>
                <option value="sa">Simulated Annealing</option>
            </select>
        </div>
        <div class="border-l border-gray-600 h-8 hidden md:block"></div>
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium text-gray-400">View:</span>
            <div id="view-selector" class="flex gap-1 bg-gray-900/50 rounded-md p-1">
                <button data-view="population" class="toggle-btn px-3 py-1 text-sm font-medium rounded-md transition-colors">Population</button>
                <button data-view="io_space" class="toggle-btn px-3 py-1 text-sm font-medium rounded-md transition-colors">Input/Output</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Button -->
    <button id="settings-btn" class="panel absolute top-4 right-4 p-2 rounded-md z-20">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="panel absolute top-16 right-4 p-4 rounded-lg shadow-2xl w-80 max-h-[calc(100vh-5rem)] overflow-y-auto hidden z-20">
        <h3 class="text-lg font-bold mb-4 text-gray-100">Settings</h3>
        <div class="space-y-6">
            <div>
                <h4 class="settings-section-header text-sm">Graphics & Performance</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Landscape Resolution: <span id="landscapeResValue" class="font-bold text-blue-400">150</span></label>
                        <input id="landscapeRes" type="range" min="30" max="10000" step="10" value="150" class="w-full h-2 bg-gray-700 rounded-lg slider">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300">Point Size: <span id="pointSizeValue" class="font-bold text-blue-400">0.4</span></label>
                        <input id="pointSize" type="range" min="0.1" max="2.0" step="0.1" value="0.4" class="w-full h-2 bg-gray-700 rounded-lg slider">
                    </div>
                     <div class="flex items-center justify-between">
                         <label for="showContours" class="text-sm font-medium text-gray-300">Show Contour Lines</label>
                         <input id="showContours" type="checkbox" class="h-4 w-4 rounded" checked>
                     </div>
                </div>
            </div>
            <div>
                <h4 class="settings-section-header text-sm">Landscape Parameters</h4>
                 <div class="space-y-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-300">Landscape Scale: <span id="landscapeScaleValue" class="font-bold text-blue-400">200</span></label>
                        <input id="landscapeScale" type="range" min="50" max="400" step="10" value="200" class="w-full h-2 bg-gray-700 rounded-lg slider">
                    </div>
                    <div id="landscape-params-container" class="space-y-2">
                        <p id="sphere-params" class="text-xs text-gray-400">The Sphere function has no tunable parameters.</p>
                        <div id="ackley-params" class="hidden space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-300">a (Amplitude): <span id="ackley_a_value">20</span></label>
                                <input id="ackley_a" type="range" min="5" max="30" step="1" value="20" class="w-full h-2 bg-gray-700 rounded-lg slider">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-300">b (Width): <span id="ackley_b_value">0.2</span></label>
                                <input id="ackley_b" type="range" min="0.05" max="0.5" step="0.01" value="0.2" class="w-full h-2 bg-gray-700 rounded-lg slider">
                            </div>
                        </div>
                        <div id="rastrigin-params" class="hidden space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-300">A (Frequency): <span id="rastrigin_a_value">10</span></label>
                                <input id="rastrigin_a" type="range" min="1" max="20" step="1" value="10" class="w-full h-2 bg-gray-700 rounded-lg slider">
                            </div>
                        </div>
                         <div id="himmelblau-params" class="hidden space-y-2">
                             <p class="text-xs text-gray-400">Himmelblau's function has no tunable parameters.</p>
                        </div>
                         <div id="rosenbrock-params" class="hidden space-y-2">
                             <p class="text-xs text-gray-400">Rosenbrock's function has no tunable parameters.</p>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
        <button id="apply-settings-btn" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Apply & Reset</button>
    </div>

    <!-- Main UI Panel -->
    <div id="ui-panel" class="panel absolute bottom-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-2xl max-w-7xl w-[95%]">
        <div id="panel-summary" class="hidden text-xs md:text-sm text-gray-300 font-mono w-full justify-between items-center"></div>
        <div id="panel-content">
            <div class="flex items-center gap-4 mb-4">
                <div class="flex items-center gap-3">
                    <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">Start</button>
                    <button id="pause-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition hidden">Pause</button>
                    <button id="reset-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition">Reset</button>
                </div>
                <div class="text-center">
                    <div class="text-xs text-gray-400">Generation</div>
                    <div id="generation-counter" class="text-xl font-bold">0</div>
                </div>
                 <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-300">Speed (Gen/s): <span id="speedValue" class="font-bold text-blue-400">5</span></label>
                    <input id="speed" type="range" min="1" max="60" step="1" value="5" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
            </div>

            <div class="border-t border-gray-700 pt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Population Size: <span id="populationSizeValue" class="font-bold text-blue-400">100</span></label>
                    <input id="populationSize" type="range" min="10" max="500" step="10" value="100" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="mutationRateControl">
                    <label class="block text-sm font-medium text-gray-300">Mutation Rate: <span id="mutationRateValue" class="font-bold text-blue-400">0.10</span></label>
                    <input id="mutationRate" type="range" min="0.01" max="1" step="0.01" value="0.1" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                 <div id="cmaSigmaControl" class="hidden">
                    <label class="block text-sm font-medium text-gray-300">Variance / &sigma;: <span id="cmaSigmaValue" class="font-bold text-blue-400">0.50</span></label>
                    <input id="cmaSigma" type="range" min="0.01" max="2.0" step="0.01" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="psoParams" class="hidden">
                    <label class="block text-sm font-medium text-gray-300">Inertia (w): <span id="psoInertiaValue" class="font-bold text-blue-400">0.7</span></label>
                    <input id="psoInertia" type="range" min="0.1" max="1.0" step="0.05" value="0.7" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="saParams" class="hidden">
                     <label class="block text-sm font-medium text-gray-300">Initial Temp: <span id="saTempValue" class="font-bold text-blue-400">1000</span></label>
                    <input id="saTemp" type="range" min="10" max="5000" step="10" value="1000" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="deFControl" class="hidden">
                    <label class="block text-sm font-medium text-gray-300">Weight (F): <span id="deFValue" class="font-bold text-blue-400">0.8</span></label>
                    <input id="deF" type="range" min="0.1" max="2.0" step="0.1" value="0.8" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="deCRControl" class="hidden">
                    <label class="block text-sm font-medium text-gray-300">Crossover (CR): <span id="deCRValue" class="font-bold text-blue-400">0.9</span></label>
                    <input id="deCR" type="range" min="0.0" max="1.0" step="0.05" value="0.9" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-300">Elite Size (%): <span id="eliteSizeValue" class="font-bold text-blue-400">5</span></label>
                     <input id="eliteSize" type="range" min="1" max="20" step="1" value="5" class="w-full h-2 bg-gray-700 rounded-lg slider">
                </div>
                <div id="selectionControl">
                    <label for="selection-strategy" class="block text-sm font-medium text-gray-300">Selection</label>
                    <select id="selection-strategy" class="rounded-md text-sm p-1 w-full mt-1">
                        <option value="tournament">Tournament</option>
                        <option value="roulette">Roulette Wheel</option>
                        <option value="rank">Rank</option>
                    </select>
                </div>
                <div id="crossoverControl">
                    <label for="crossover-strategy" class="block text-sm font-medium text-gray-300">Crossover</label>
                    <select id="crossover-strategy" class="rounded-md text-sm p-1 w-full mt-1">
                        <option value="single_point">Single-Point</option>
                        <option value="two_point">Two-Point</option>
                        <option value="uniform">Uniform</option>
                        <option value="arithmetic">Arithmetic</option>
                    </select>
                </div>
            </div>
        </div>
        <button id="collapse-btn" class="absolute -top-3 right-4 bg-gray-700 hover:bg-gray-600 p-1 rounded-full text-white">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
    </div>

    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/" } }</script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- SCENE & STATE ---
        let scene, camera, renderer, controls;
        const clock = new THREE.Clock();

        const populationView = new THREE.Group();
        const ioSpaceView = new THREE.Group();
        let populationPoints, cmaEsEllipsoid, landscapeMesh, optimumMarker;
        let inputSpacePoints, outputSpacePoints, ioConnectors;
        let populationGrowthState = { isAnimating: false, currentCount: 0, startTime: 0, duration: 1.0 };
        let lastGenerationTime = 0;

        const state = {
            algorithm: 'ga', algoCategory: 'GA', view: 'population', isRunning: false, landscape: 'sphere',
            populationSize: 100, mutationRate: 0.1, eliteSize: 5,
            de_F: 0.8, de_CR: 0.9, pso_w: 0.7, sa_temp: 1000, cma_sigma: 0.5,
            speed: 5, generation: 0,
            population: [], selectionFn: tournamentSelection, crossoverFn: singlePointCrossover,
            cma: { mean: new THREE.Vector3(), covarianceMatrix: new THREE.Matrix3().identity() },
            landscapeRes: 150, pointSize: 0.4, showContours: true, landscapeScale: 200,
            landscapeParams: { ackley_a: 20, ackley_b: 0.2, rastrigin_a: 10 }
        };

        const ui = {
            generationCounter: document.getElementById('generation-counter'),
            startBtn: document.getElementById('start-btn'),
            pauseBtn: document.getElementById('pause-btn'),
            resetBtn: document.getElementById('reset-btn'),
            populationSizeSlider: document.getElementById('populationSize'),
            populationSizeValue: document.getElementById('populationSizeValue'),
            mutationRateSlider: document.getElementById('mutationRate'),
            mutationRateValue: document.getElementById('mutationRateValue'),
            eliteSizeSlider: document.getElementById('eliteSize'),
            eliteSizeValue: document.getElementById('eliteSizeValue'),
            speedSlider: document.getElementById('speed'),
            speedValue: document.getElementById('speedValue'),
            crossoverControl: document.getElementById('crossoverControl'),
            selectionControl: document.getElementById('selectionControl'),
            mutationRateControl: document.getElementById('mutationRateControl'),
            cmaSigmaControl: document.getElementById('cmaSigmaControl'),
            cmaSigmaSlider: document.getElementById('cmaSigma'),
            cmaSigmaValue: document.getElementById('cmaSigmaValue'),
            deFControl: document.getElementById('deFControl'),
            deCRControl: document.getElementById('deCRControl'),
            deFSlider: document.getElementById('deF'),
            deFValue: document.getElementById('deFValue'),
            deCRSlider: document.getElementById('deCR'),
            deCRValue: document.getElementById('deCRValue'),
            psoParams: document.getElementById('psoParams'),
            psoInertiaSlider: document.getElementById('psoInertia'),
            psoInertiaValue: document.getElementById('psoInertiaValue'),
            saParams: document.getElementById('saParams'),
            saTempSlider: document.getElementById('saTemp'),
            saTempValue: document.getElementById('saTempValue'),
            collapseBtn: document.getElementById('collapse-btn'),
            uiPanel: document.getElementById('ui-panel'),
            panelSummary: document.getElementById('panel-summary'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsPanel: document.getElementById('settings-panel'),
            applySettingsBtn: document.getElementById('apply-settings-btn'),
            landscapeResSlider: document.getElementById('landscapeRes'),
            landscapeResValue: document.getElementById('landscapeResValue'),
            pointSizeSlider: document.getElementById('pointSize'),
            pointSizeValue: document.getElementById('pointSizeValue'),
            landscapeScaleSlider: document.getElementById('landscapeScale'),
            landscapeScaleValue: document.getElementById('landscapeScaleValue'),
            gaAlgoSelector: document.getElementById('ga-algo-selector'),
            esAlgoSelector: document.getElementById('es-algo-selector'),
            landscapeParams: {
                sphere: document.getElementById('sphere-params'),
                ackley: document.getElementById('ackley-params'),
                rastrigin: document.getElementById('rastrigin-params'),
                himmelblau: document.getElementById('himmelblau-params'),
                rosenbrock: document.getElementById('rosenbrock-params'),
                ackley_a: document.getElementById('ackley_a'),
                ackley_a_value: document.getElementById('ackley_a_value'),
                ackley_b: document.getElementById('ackley_b'),
                ackley_b_value: document.getElementById('ackley_b_value'),
                rastrigin_a: document.getElementById('rastrigin_a'),
                rastrigin_a_value: document.getElementById('rastrigin_a_value'),
            }
        };

        const landscapes = {
            sphere: { fn: (x, z, p) => (x*x + z*z) / 50, optimum: new THREE.Vector3(0, 0, 0), domain: 30 },
            ackley: { fn: (x, z, p) => (-p.ackley_a * Math.exp(-p.ackley_b * Math.sqrt(0.5 * (x*x + z*z))) - Math.exp(0.5 * (Math.cos(2 * Math.PI * x) + Math.cos(2 * Math.PI * z))) + p.ackley_a + Math.E) / 2, optimum: new THREE.Vector3(0, 0, 0), domain: 32.768 },
            rastrigin: { fn: (x, z, p) => (p.rastrigin_a * 2 + (x*x - p.rastrigin_a * Math.cos(2 * Math.PI * x)) + (z*z - p.rastrigin_a * Math.cos(2 * Math.PI * z))) / 10, optimum: new THREE.Vector3(0, 0, 0), domain: 5.12 },
            himmelblau: { fn: (x, z, p) => ((x*x + z - 11)**2 + (x + z*z - 7)**2) / 100, optimum: new THREE.Vector3(3, 2, 0), domain: 6 },
            rosenbrock: { fn: (x, z, p) => ((1-x)**2 + 100 * (z - x*x)**2) / 100, optimum: new THREE.Vector3(1, 1, 0), domain: 2.048}
        };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('container').appendChild(renderer.domElement);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxDistance = 1000;

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
            directionalLight.position.set(50, 100, 75);
            scene.add(directionalLight);
            
            scene.add(populationView, ioSpaceView);

            setupEventListeners();
            resetSimulation();
            setupCameraForView(state.view);
        }
        
        // --- EVENT LISTENERS & UI ---
        function setupEventListeners() {
            document.getElementById('landscape-selector').addEventListener('change', e => { state.landscape = e.target.value; updateLandscapeParamUI(); resetSimulation(); });
            document.querySelectorAll('#algo-category-selector button').forEach(btn => btn.addEventListener('click', () => switchAlgoCategory(btn.dataset.category)));
            ui.gaAlgoSelector.addEventListener('change', e => switchAlgorithm(e.target.value));
            ui.esAlgoSelector.addEventListener('change', e => switchAlgorithm(e.target.value));
            document.querySelectorAll('#view-selector button').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            ui.settingsBtn.addEventListener('click', () => ui.settingsPanel.classList.toggle('hidden'));

            // Settings Panel
            ui.landscapeResSlider.addEventListener('input', e => ui.landscapeResValue.textContent = e.target.value);
            ui.pointSizeSlider.addEventListener('input', e => ui.pointSizeValue.textContent = parseFloat(e.target.value).toFixed(1));
            ui.landscapeScaleSlider.addEventListener('input', e => ui.landscapeScaleValue.textContent = e.target.value);
            ui.landscapeParams.ackley_a.addEventListener('input', e => ui.landscapeParams.ackley_a_value.textContent = e.target.value);
            ui.landscapeParams.ackley_b.addEventListener('input', e => ui.landscapeParams.ackley_b_value.textContent = parseFloat(e.target.value).toFixed(2));
            ui.landscapeParams.rastrigin_a.addEventListener('input', e => ui.landscapeParams.rastrigin_a_value.textContent = e.target.value);

            ui.applySettingsBtn.addEventListener('click', () => {
                state.landscapeRes = parseInt(ui.landscapeResSlider.value);
                state.pointSize = parseFloat(ui.pointSizeSlider.value);
                state.showContours = document.getElementById('showContours').checked;
                state.landscapeScale = parseInt(ui.landscapeScaleSlider.value);
                state.landscapeParams.ackley_a = parseFloat(ui.landscapeParams.ackley_a.value);
                state.landscapeParams.ackley_b = parseFloat(ui.landscapeParams.ackley_b.value);
                state.landscapeParams.rastrigin_a = parseFloat(ui.landscapeParams.rastrigin_a.value);
                ui.settingsPanel.classList.add('hidden');
                resetSimulation();
            });

            // Main UI Panel (Live updates)
            ui.startBtn.addEventListener('click', startSimulation);
            ui.pauseBtn.addEventListener('click', pauseSimulation);
            ui.resetBtn.addEventListener('click', resetSimulation);
            ui.collapseBtn.addEventListener('click', togglePanelCollapse);
            ui.speedSlider.addEventListener('input', e => { state.speed = parseInt(e.target.value); ui.speedValue.textContent = state.speed; });
            ui.populationSizeSlider.addEventListener('input', e => ui.populationSizeValue.textContent = e.target.value);
            ui.populationSizeSlider.addEventListener('change', e => { state.populationSize = parseInt(e.target.value); resetSimulation(); });
            ui.mutationRateSlider.addEventListener('input', e => { state.mutationRate = parseFloat(e.target.value); ui.mutationRateValue.textContent = state.mutationRate.toFixed(2); });
            ui.cmaSigmaSlider.addEventListener('input', e => { state.cma_sigma = parseFloat(e.target.value); ui.cmaSigmaValue.textContent = state.cma_sigma.toFixed(2); });
            ui.eliteSizeSlider.addEventListener('input', e => { state.eliteSize = parseInt(e.target.value); ui.eliteSizeValue.textContent = state.eliteSize; });
            ui.deFSlider.addEventListener('input', e => { state.de_F = parseFloat(e.target.value); ui.deFValue.textContent = state.de_F.toFixed(2); });
            ui.deCRSlider.addEventListener('input', e => { state.de_CR = parseFloat(e.target.value); ui.deCRValue.textContent = state.de_CR.toFixed(2); });
            ui.psoInertiaSlider.addEventListener('input', e => { state.pso_w = parseFloat(e.target.value); ui.psoInertiaValue.textContent = state.pso_w.toFixed(2); });
            ui.saTempSlider.addEventListener('input', e => { state.sa_temp = parseFloat(e.target.value); ui.saTempValue.textContent = state.sa_temp; });
            document.getElementById('selection-strategy').addEventListener('change', e => state.selectionFn = { tournament: tournamentSelection, roulette: rouletteWheelSelection, rank: rankSelection }[e.target.value]);
            document.getElementById('crossover-strategy').addEventListener('change', e => state.crossoverFn = { single_point: singlePointCrossover, two_point: twoPointCrossover, uniform: uniformCrossover, arithmetic: arithmeticCrossover }[e.target.value]);
            window.addEventListener('resize', onWindowResize);
        }

        // --- CONTROL & UI FUNCTIONS ---
        function startSimulation() { state.isRunning = true; ui.startBtn.classList.add('hidden'); ui.pauseBtn.classList.remove('hidden'); updateSummaryBar(); }
        function pauseSimulation() { state.isRunning = false; ui.startBtn.classList.remove('hidden'); ui.pauseBtn.classList.add('hidden'); updateSummaryBar(); }
        function resetSimulation() { pauseSimulation(); state.generation = 0; ui.generationCounter.textContent = '0'; setupViews(); initializePopulation(); updateVisualization(); startPopulationGrowthAnimation(); }
        function switchAlgoCategory(category) { if (state.algoCategory === category) return; state.algoCategory = category; document.querySelectorAll('#algo-category-selector button').forEach(btn => btn.classList.toggle('active', btn.dataset.category === category)); if (category === 'GA') { ui.gaAlgoSelector.classList.remove('hidden'); ui.esAlgoSelector.classList.add('hidden'); switchAlgorithm(ui.gaAlgoSelector.value); } else { ui.gaAlgoSelector.classList.add('hidden'); ui.esAlgoSelector.classList.remove('hidden'); switchAlgorithm(ui.esAlgoSelector.value); } }
        function switchAlgorithm(algo) {
            state.algorithm = algo;
            const controls = {sel:false, cross:false, mut:false, cma: false, de:false, pso:false, sa:false};
            if (algo==='ga' || algo==='de') { controls.sel = true; controls.cross = true; }
            if (algo==='ga' || algo==='es') { controls.mut = true; }
            if (algo==='cma-es') { controls.cma = true; }
            if (algo==='de') { controls.de = true; }
            if (algo==='pso') { controls.pso = true; }
            if (algo==='sa') { controls.sa = true; }

            ui.selectionControl.style.display = controls.sel ? 'block':'none';
            ui.crossoverControl.style.display = controls.cross ? 'block':'none';
            ui.mutationRateControl.style.display = controls.mut ? 'block':'none';
            ui.cmaSigmaControl.style.display = controls.cma ? 'block':'none';
            ui.deFControl.style.display = ui.deCRControl.style.display = controls.de ? 'block':'none';
            ui.psoParams.style.display = controls.pso ? 'block':'none';
            ui.saParams.style.display = controls.sa ? 'block':'none';

            if (!state.isRunning) { resetSimulation(); }
        }
        function switchView(view) { if (state.view === view) return; state.view = view; document.querySelectorAll('#view-selector button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view)); populationView.visible = view === 'population'; ioSpaceView.visible = view === 'io_space'; setupViews(); setupCameraForView(view); }
        function togglePanelCollapse() { const isCollapsed = ui.uiPanel.classList.toggle('collapsed'); ui.panelSummary.classList.toggle('hidden', !isCollapsed); if (isCollapsed) updateSummaryBar(); }
        function updateSummaryBar() { if (!ui.uiPanel.classList.contains('collapsed')) return; const playIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`; const pauseIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.75 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75zM14.25 4.5a.75.75 0 00-.75.75v10.5a.75.75 0 001.5 0V5.25a.75.75 0 00-.75-.75z"></path></svg>`; const resetIcon = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.312 11.342a5.986 5.986 0 01-4.654 4.654c.643.21 1.316.335 2.023.372a.75.75 0 01.028 1.498 7.483 7.483 0 00-2.53-.464c-4.142 0-7.5-3.358-7.5-7.5s3.358-7.5 7.5-7.5a7.487 7.487 0 016.112 3.626.75.75 0 11-1.299.75A5.987 5.987 0 0010.318 4.5a6 6 0 00-6 6c0 2.668 1.74 4.943 4.158 5.688a.75.75 0 01.658-1.374 5.986 5.986 0 014.178-4.178.75.75 0 111.374-.658z" clip-rule="evenodd"></path><path d="M16.5 6.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75z"></path><path fill-rule="evenodd" d="M16 1.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V2.25A.75.75 0 0116 1.5z" clip-rule="evenodd"></path></svg>`; const summaryHTML = `<div class="flex items-center gap-3"><button id="summary-play-btn" class="summary-btn text-green-400 ${state.isRunning?'hidden':''}">${playIcon}</button><button id="summary-pause-btn" class="summary-btn text-yellow-400 ${!state.isRunning?'hidden':''}">${pauseIcon}</button><button id="summary-reset-btn" class="summary-btn text-red-400">${resetIcon}</button></div><div class="flex items-center gap-2 md:gap-4 flex-wrap justify-end"><span>Algo: <strong class="text-blue-400">${state.algorithm.toUpperCase()}</strong></span><span>Gen: <strong class="text-blue-400">${state.generation}</strong></span><span class="hidden sm:inline">Pop: <strong class="text-blue-400">${state.populationSize}</strong></span><span class="hidden md:inline">Landscape: <strong class="text-blue-400">${state.landscape}</strong></span></div>`; ui.panelSummary.innerHTML = summaryHTML; document.getElementById('summary-play-btn')?.addEventListener('click', startSimulation); document.getElementById('summary-pause-btn')?.addEventListener('click', pauseSimulation); document.getElementById('summary-reset-btn')?.addEventListener('click', resetSimulation); }
        function updateLandscapeParamUI() {
            Object.values(ui.landscapeParams).forEach(el => { if (el.tagName === 'DIV' || el.tagName === 'P') el.classList.add('hidden'); });
            const activeParams = ui.landscapeParams[state.landscape];
            if (activeParams) activeParams.classList.remove('hidden');
        }

        // --- ALGORITHMS ---
        function runNextGeneration(){state.population.forEach(p=>p.fitness=evaluateFitness(p.genes));state.population.sort((a,b)=>a.fitness-b.fitness);if(state.algorithm==='ga')runGAGeneration();else if(state.algorithm==='es')runESGeneration();else if(state.algorithm==='de')runDEGeneration();else if(state.algorithm==='cma-es')runCMAESGeneration();else if(state.algorithm==='pso')runPSOGeneration();else if(state.algorithm==='sa')runSAGeneration();state.generation++;}
        function runGAGeneration(){const newPop=[JSON.parse(JSON.stringify(state.population[0]))];while(newPop.length<state.populationSize){const p1=state.selectionFn(state.population);const p2=state.selectionFn(state.population);const children=state.crossoverFn(p1,p2);children.forEach(c=>{mutate(c);if(newPop.length<state.populationSize)newPop.push(c);});}state.population=newPop;}
        function runESGeneration(){const newPop=[];const parents=state.population.slice(0,Math.floor(state.populationSize/2));newPop.push(...parents);while(newPop.length<state.populationSize){const p=parents[Math.floor(Math.random()*parents.length)];const child=JSON.parse(JSON.stringify(p));mutate(child);newPop.push(child);}newPop.forEach(p=>p.fitness=evaluateFitness(p.genes));newPop.sort((a,b)=>a.fitness-b.fitness);state.population=newPop.slice(0,state.populationSize);}
        function runDEGeneration(){const newPop=[];for(let i=0;i<state.populationSize;i++){const target=state.population[i];let a,b,c;do{a=state.population[Math.floor(Math.random()*state.populationSize)];}while(a===target);do{b=state.population[Math.floor(Math.random()*state.populationSize)];}while(b===target||b===a);do{c=state.population[Math.floor(Math.random()*state.populationSize)];}while(c===target||c===a||c===b);const mutant={genes:[],fitness:0};const R=Math.floor(Math.random()*target.genes.length);for(let j=0;j<target.genes.length;j++){if(Math.random()<state.de_CR||j===R){mutant.genes[j]=a.genes[j]+state.de_F*(b.genes[j]-c.genes[j]);}else{mutant.genes[j]=target.genes[j];}}mutant.fitness=evaluateFitness(mutant.genes);newPop.push(mutant.fitness<target.fitness?mutant:target);}state.population=newPop;}
        function runCMAESGeneration(){const best=state.population.slice(0,Math.floor(state.populationSize*0.25));const newMean=new THREE.Vector3(0,0,0);best.forEach(ind=>newMean.add(new THREE.Vector3().fromArray(ind.genes)));newMean.divideScalar(best.length);state.cma.mean.lerp(newMean,0.1);const bestVec=new THREE.Vector3().fromArray(best[0].genes).normalize();const randVec=new THREE.Vector3(Math.random(),Math.random(),Math.random()).normalize();const axis2=new THREE.Vector3().crossVectors(bestVec,randVec).normalize();const axis3=new THREE.Vector3().crossVectors(bestVec,axis2).normalize();state.cma.covarianceMatrix.set(bestVec.x,axis2.x,axis3.x,bestVec.y,axis2.y,axis3.y,bestVec.z,axis2.z,axis3.z);state.population=[];for(let i=0;i<state.populationSize;i++){const s=new THREE.Vector3((Math.random()-0.5)*2,(Math.random()-0.5)*2,(Math.random()-0.5)*2);s.multiplyScalar(state.cma_sigma * 5); s.applyMatrix3(state.cma.covarianceMatrix); s.add(state.cma.mean); state.population.push({genes:s.toArray(),fitness:0});}}
        function runPSOGeneration() { const c1 = 1.5, c2 = 1.5; const gBest = state.population[0]; state.population.forEach(p => { for(let i=0; i < p.genes.length; i++) { const r1 = Math.random(), r2 = Math.random(); p.velocity[i] = state.pso_w * p.velocity[i] + c1 * r1 * (p.pBest.genes[i] - p.genes[i]) + c2 * r2 * (gBest.genes[i] - p.genes[i]); p.genes[i] += p.velocity[i]; } p.fitness = evaluateFitness(p.genes); if (p.fitness < p.pBest.fitness) { p.pBest = {genes: [...p.genes], fitness: p.fitness}; } }); }
        function runSAGeneration() { const current = state.population[0]; const neighbor = {genes: [...current.genes], fitness: 0}; const domain = landscapes[state.landscape].domain; for (let i = 0; i < neighbor.genes.length; i++) { neighbor.genes[i] += (Math.random() - 0.5) * (state.sa_temp / 1000) * domain; } neighbor.fitness = evaluateFitness(neighbor.genes); const delta = neighbor.fitness - current.fitness; if (delta < 0 || Math.exp(-delta / state.sa_temp) > Math.random()) { state.population[0] = neighbor; } state.sa_temp *= 0.99; }
        function initializePopulation(){state.population=[];const domain=landscapes[state.landscape].domain;state.cma.mean=new THREE.Vector3((Math.random()-0.5)*domain,(Math.random()-0.5)*domain,(Math.random()-0.5)*domain);state.cma.covarianceMatrix.identity();for(let i=0;i<state.populationSize;i++){ const ind = {genes:[(Math.random()-0.5)*domain*2,(Math.random()-0.5)*domain*2,(Math.random()-0.5)*domain*2], fitness:Infinity}; if (state.algorithm === 'pso') { ind.velocity = [0,0,0]; ind.pBest = {genes:[...ind.genes], fitness: Infinity}; } state.population.push(ind); } state.sa_temp = parseFloat(ui.saTempSlider.value); }
        function evaluateFitness(genes){return landscapes[state.landscape].fn(genes[0], genes[2], state.landscapeParams);}
        function tournamentSelection(pop){const size=5;let best=pop[Math.floor(Math.random()*pop.length)];for(let i=1;i<size;i++){const cont=pop[Math.floor(Math.random()*pop.length)];if(cont.fitness<best.fitness)best=cont;}return best;}
        function rouletteWheelSelection(pop){const maxFit=Math.max(...pop.map(p=>p.fitness).filter(f=>isFinite(f)));const invFit=pop.map(p=>isFinite(p.fitness)?maxFit-p.fitness:0);const total=invFit.reduce((s,i)=>s+i,0);if(total<=0)return tournamentSelection(pop);let pick=Math.random()*total;for(let i=0;i<pop.length;i++){pick-=invFit[i];if(pick<=0)return pop[i];}return pop[pop.length-1];}
        function rankSelection(pop){const ranks=pop.map((_,i)=>pop.length-i);const total=ranks.reduce((s,r)=>s+r,0);let pick=Math.random()*total;for(let i=0;i<pop.length;i++){pick-=ranks[i];if(pick<=0)return pop[i];}return pop[pop.length-1];}
        function singlePointCrossover(p1,p2){const cp=1+Math.floor(Math.random()*(p1.genes.length-2));return[{genes:p1.genes.slice(0,cp).concat(p2.genes.slice(cp)),f:0},{genes:p2.genes.slice(0,cp).concat(p1.genes.slice(cp)),f:0}];}
        function twoPointCrossover(p1,p2){let cp1=Math.floor(Math.random()*p1.genes.length),cp2=Math.floor(Math.random()*p1.genes.length);if(cp1>cp2)[cp1,cp2]=[cp2,cp1];return[{genes:p1.genes.slice(0,cp1).concat(p2.genes.slice(cp1,cp2)).concat(p1.genes.slice(cp2)),f:0},{genes:p2.genes.slice(0,cp1).concat(p1.genes.slice(cp1,cp2)).concat(p2.genes.slice(cp2)),f:0}];}
        function uniformCrossover(p1,p2){const c1g=[],c2g=[];for(let i=0;i<p1.genes.length;i++){if(Math.random()<0.5){c1g.push(p1.genes[i]);c2g.push(p2.genes[i]);}else{c1g.push(p2.genes[i]);c2g.push(p1.genes[i]);}}return[{genes:c1g,f:0},{genes:c2g,f:0}];}
        function arithmeticCrossover(p1,p2){const a=Math.random(),c1g=[],c2g=[];for(let i=0;i<p1.genes.length;i++){c1g.push(a*p1.genes[i]+(1-a)*p2.genes[i]);c2g.push((1-a)*p1.genes[i]+a*p2.genes[i]);}return[{genes:c1g,f:0},{genes:c2g,f:0}];}
        function mutate(ind){for(let i=0;i<ind.genes.length;i++){if(Math.random()<state.mutationRate){ind.genes[i]+=(Math.random()-0.5)*state.mutationRate*5;}}}

        // --- 3D VISUALIZATION ---
        function setupViews() {
            populationView.clear();
            ioSpaceView.clear();

            if (state.view === 'population') {
                landscapeMesh = createLandscapeMesh();
                populationView.add(landscapeMesh);
                const pointsGeom = new THREE.BufferGeometry();
                pointsGeom.setAttribute('position', new THREE.Float32BufferAttribute(new Float32Array(state.populationSize * 3), 3));
                pointsGeom.setAttribute('color', new THREE.Float32BufferAttribute(new Float32Array(state.populationSize * 3), 3));
                populationPoints = new THREE.Points(pointsGeom, new THREE.PointsMaterial({ size: state.pointSize, vertexColors: true, transparent: true, opacity: 0.9 }));
                populationView.add(populationPoints);
                const optimumGeom = new THREE.SphereGeometry(state.landscapeScale * 0.005, 16, 16);
                optimumMarker = new THREE.Mesh(optimumGeom, new THREE.MeshBasicMaterial({ color: 0xffff00 }));
                populationView.add(optimumMarker);
                const ellipsoidGeom = new THREE.SphereGeometry(1, 32, 16);
                cmaEsEllipsoid = new THREE.Mesh(ellipsoidGeom, new THREE.MeshBasicMaterial({color: 0xfde047, wireframe: true, transparent: true, opacity: 0.5}));
                populationView.add(cmaEsEllipsoid);
            } else { // io_space
                const spaceSize = state.landscapeScale * 0.4;
                const separation = spaceSize + 40;
                const inputAxes = create3DAxes(spaceSize);
                inputAxes.position.x = -separation / 2;
                ioSpaceView.add(inputAxes);
                const outputAxes = create3DAxes(spaceSize);
                outputAxes.position.x = separation / 2;
                ioSpaceView.add(outputAxes);

                const inputPointsGeom = new THREE.BufferGeometry();
                inputPointsGeom.setAttribute('position', new THREE.Float32BufferAttribute(new Float32Array(state.populationSize * 3), 3));
                inputSpacePoints = new THREE.Points(inputPointsGeom, new THREE.PointsMaterial({ color: 0xf87171, size: 0.8 }));
                ioSpaceView.add(inputSpacePoints);
                const outputPointsGeom = new THREE.BufferGeometry();
                outputPointsGeom.setAttribute('position', new THREE.Float32BufferAttribute(new Float32Array(state.populationSize * 3), 3));
                outputSpacePoints = new THREE.Points(outputPointsGeom, new THREE.PointsMaterial({ color: 0x60a5fa, size: 0.8 }));
                ioSpaceView.add(outputSpacePoints);
                const lineGeom = new THREE.BufferGeometry();
                lineGeom.setAttribute('position', new THREE.BufferAttribute(new Float32Array(state.populationSize * 6), 3));
                ioConnectors = new THREE.LineSegments(lineGeom, new THREE.LineBasicMaterial({color: 0x6b7280, transparent: true, opacity: 0.3}));
                ioSpaceView.add(ioConnectors);
            }
            switchAlgoCategory(state.algoCategory);
            switchView(state.view);
        }
        
        function create3DAxes(size) {
            const axes = new THREE.Group();
            const half = size / 2;
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-half,0,0), new THREE.Vector3(half,0,0)]), new THREE.LineBasicMaterial({color: 0xef4444})));
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,-half,0), new THREE.Vector3(0,half,0)]), new THREE.LineBasicMaterial({color: 0x22c55e})));
            axes.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,-half), new THREE.Vector3(0,0,half)]), new THREE.LineBasicMaterial({color: 0x3b82f6})));
            axes.add(new THREE.GridHelper(size, 10, 0x444444, 0x222222));
            return axes;
        }

        function createLandscapeMesh() {
            const landscape = landscapes[state.landscape];
            const domain = landscape.domain;
            const res = state.landscapeRes;
            const scale = state.landscapeScale;
            const geom = new THREE.BufferGeometry();
            const vertices = new Float32Array((res + 1) * (res + 1) * 3);
            const colors = new Float32Array((res + 1) * (res + 1) * 3);
            const indices = [];
            
            const step = scale / res;
            const halfSize = scale / 2;
            
            for (let i = 0, z = -halfSize; i <= res; i++, z += step) {
                for (let j = 0, x = -halfSize; j <= res; j++, x += step) {
                    const idx = (i * (res + 1) + j) * 3;
                    const domainX = x * (domain / halfSize);
                    const domainZ = z * (domain / halfSize);
                    const y = landscape.fn(domainX, domainZ, state.landscapeParams);
                    
                    vertices[idx] = x;
                    vertices[idx + 1] = y;
                    vertices[idx + 2] = z;
                    
                    const isContour = state.showContours && Math.abs((y * 10) % 2) < 0.2;
                    const baseColor = new THREE.Color().setHSL(0.6 - (y / 30) * 0.5, 0.5, 0.3);
                    const finalColor = isContour ? new THREE.Color(0x9ca3af) : baseColor;
                    colors[idx] = finalColor.r;
                    colors[idx + 1] = finalColor.g;
                    colors[idx + 2] = finalColor.b;
                }
            }

            for (let i = 0; i < res; i++) {
                for (let j = 0; j < res; j++) {
                    const a = i * (res + 1) + j;
                    const b = a + 1;
                    const c = (i + 1) * (res + 1) + j;
                    const d = c + 1;
                    indices.push(a, c, b);
                    indices.push(b, c, d);
                }
            }
            
            geom.setIndex(indices);
            geom.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
            geom.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geom.computeVertexNormals();
            
            const mat = new THREE.MeshStandardMaterial({ vertexColors: true, metalness: 0.2, roughness: 0.8 });
            return new THREE.Mesh(geom, mat);
        }

        function getLandscapeHeight(x, z) {
            const landscape = landscapes[state.landscape];
            const domain = landscape.domain;
            const halfSize = state.landscapeScale / 2;
            const res = state.landscapeRes;
            const step = state.landscapeScale / res;

            if (x < -halfSize || x > halfSize || z < -halfSize || z > halfSize) return 0;

            const gridX = Math.floor((x + halfSize) / step);
            const gridZ = Math.floor((z + halfSize) / step);

            const x1 = -halfSize + gridX * step;
            const z1 = -halfSize + gridZ * step;
            
            const domainX1 = x1 * (domain / halfSize);
            const domainZ1 = z1 * (domain / halfSize);
            const domainX2 = (x1 + step) * (domain / halfSize);
            const domainZ2 = (z1 + step) * (domain / halfSize);

            const y11 = landscape.fn(domainX1, domainZ1, state.landscapeParams);
            const y12 = landscape.fn(domainX1, domainZ2, state.landscapeParams);
            const y21 = landscape.fn(domainX2, domainZ1, state.landscapeParams);
            const y22 = landscape.fn(domainX2, domainZ2, state.landscapeParams);
            
            const tx = (x - x1) / step;
            const tz = (z - z1) / step;

            const y1 = y11 * (1 - tx) + y21 * tx;
            const y2 = y12 * (1 - tx) + y22 * tx;

            return y1 * (1 - tz) + y2 * tz;
        }

        function updateVisualization() {
            if (!state.population || state.population.length === 0) return;
            
            const landscape = landscapes[state.landscape];
            optimumMarker.position.copy(landscape.optimum);
            optimumMarker.position.y = landscape.fn(landscape.optimum.x, landscape.optimum.z, state.landscapeParams) + 0.5;

            cmaEsEllipsoid.visible = state.algorithm === 'cma-es';
            if(cmaEsEllipsoid.visible) {
                const transformMatrix = new THREE.Matrix4().setFromMatrix3(state.cma.covarianceMatrix);
                const scaleMatrix = new THREE.Matrix4().makeScale(state.cma_sigma * 20, state.cma_sigma * 10, state.cma_sigma * 10);
                transformMatrix.multiply(scaleMatrix);
                cmaEsEllipsoid.matrix.makeTranslation(state.cma.mean.x, state.cma.mean.y, state.cma.mean.z).multiply(transformMatrix);
                cmaEsEllipsoid.matrixAutoUpdate = false;
            }

            if (state.view === 'population') {
                const popPos = populationPoints.geometry.attributes.position.array;
                const popColors = populationPoints.geometry.attributes.color.array;
                const eliteCount = Math.floor(state.populationSize * (state.eliteSize / 100));
                const eliteColor = new THREE.Color(0xf472b6);
                const hotColor = new THREE.Color(0xff4500);
                const coolColor = new THREE.Color(0x00bfff);
                const nonElitePop = state.population.slice(eliteCount);
                const minFitness = nonElitePop.length > 0 ? nonElitePop[0].fitness : 0;
                const maxFitness = nonElitePop.length > 0 ? nonElitePop[nonElitePop.length - 1].fitness : minFitness;
                const fitnessRange = maxFitness - minFitness;

                for (let i = 0; i < state.populationSize; i++) {
                    const ind = state.population[i];
                    if (!ind) continue;
                    let color;
                    if (i < eliteCount) { color = eliteColor; } 
                    else { color = new THREE.Color(); const normFit = fitnessRange > 0.001 ? (ind.fitness - minFitness) / fitnessRange : 0; color.lerpColors(coolColor, hotColor, Math.min(1, Math.max(0, normFit))); }
                    popColors[i*3] = color.r; popColors[i*3+1] = color.g; popColors[i*3+2] = color.b;
                    popPos[i*3]=ind.genes[0]; popPos[i*3+2]=ind.genes[2];
                    popPos[i*3+1] = getLandscapeHeight(ind.genes[0], ind.genes[2]) + 0.2;
                }
                populationPoints.geometry.attributes.position.needsUpdate = true;
                populationPoints.geometry.attributes.color.needsUpdate = true;

            } else { // io_space
                const inputPos = inputSpacePoints.geometry.attributes.position.array;
                const outputPos = outputSpacePoints.geometry.attributes.position.array;
                const linePos = ioConnectors.geometry.attributes.position.array;
                const domain = landscape.domain;
                const axisHalfSize = (state.landscapeScale * 0.4) / 2;
                const separation = axisHalfSize*2 + 40;

                 for (let i = 0; i < state.populationSize; i++) {
                    const ind = state.population[i];
                    if (!ind) continue;
                    const ix = Math.max(-domain, Math.min(domain, ind.genes[0])) / domain * axisHalfSize;
                    const iy = Math.max(-domain, Math.min(domain, ind.genes[1])) / domain * axisHalfSize;
                    const iz = Math.max(-domain, Math.min(domain, ind.genes[2])) / domain * axisHalfSize;
                    inputPos[i*3]=ix - separation/2; inputPos[i*3+1]=iy; inputPos[i*3+2]=iz;
                    const normFit = Math.min(ind.fitness / 50, 1.0);
                    outputPos[i*3] = separation/2; outputPos[i*3+1]=(normFit - 0.5) * (axisHalfSize*2); outputPos[i*3+2]=0;
                    linePos[i*6]=inputPos[i*3]; linePos[i*6+1]=inputPos[i*3+1]; linePos[i*6+2]=inputPos[i*3+2];
                    linePos[i*6+3]=outputPos[i*3]; linePos[i*6+4]=outputPos[i*3+1]; linePos[i*6+5]=outputPos[i*3+2];
                }
                inputSpacePoints.geometry.attributes.position.needsUpdate = true;
                outputSpacePoints.geometry.attributes.position.needsUpdate = true;
                ioConnectors.geometry.attributes.position.needsUpdate = true;
            }
        }
        
        function setupCameraForView(view) { 
            const scale = state.landscapeScale;
            if (view === 'population') { 
                camera.position.set(scale * 0.2, scale * 0.25, scale * 0.3); 
                controls.target.set(0, 0, 0); 
            } else { 
                camera.position.set(0, 0, scale * 0.75); 
                controls.target.set(0, 0, 0); 
            } 
        }
        function startPopulationGrowthAnimation() { populationGrowthState.isAnimating = true; populationGrowthState.startTime = clock.getElapsedTime(); if(populationPoints) populationPoints.geometry.setDrawRange(0, 0); }

        function animate() {
            requestAnimationFrame(animate);
            const now = clock.getElapsedTime();
            if (populationGrowthState.isAnimating) { const progress = Math.min((now - populationGrowthState.startTime) / populationGrowthState.duration, 1.0); if(populationPoints) populationPoints.geometry.setDrawRange(0, Math.floor(progress * state.populationSize)); if (progress >= 1.0) populationGrowthState.isAnimating = false; }
            if (state.isRunning && (now - lastGenerationTime) > (1 / state.speed)) { runNextGeneration(); updateVisualization(); ui.generationCounter.textContent = state.generation; updateSummaryBar(); lastGenerationTime = now; }
            controls.update();
            renderer.render(scene, camera);
        }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio); }
    </script>
</body>
</html>

