          const gravitationalForce = -G * mass / (r * r);
                    const acceleration = ray.position.clone().normalize().multiplyScalar(gravitationalForce);
                    const frameDragTerm = (2 * G * mass * a) / (r * r * r * c);
                    const tangentDir = spinAxis.clone().cross(ray.position).normalize();
                    const frameDragVel = tangentDir.multiplyScalar(frameDragTerm * 100);
                    acceleration.add(frameDragVel);
                    ray.velocity.add(acceleration.multiplyScalar(dt * 20));
                    ray.position.add(ray.velocity.clone().multiplyScalar(dt * 20));

                    const positions = ray.line.geometry.attributes.position;
                    const direction = ray.velocity.clone().normalize();
                    let side = direction.clone().cross(new THREE.Vector3(0, 1, 0));
                    if (side.lengthSq() < 0.001) side.cross(new THREE.Vector3(1, 0, 0));
                    side.normalize();

                    const amplitude = 0.2 / (timeMultiplier + 0.5);
                    const wavePhase = time * 20;

                    for (let i = 0; i < NUM_WAVE_POINTS; i++) {
                        const pointOnLine = ray.position.clone().add(direction.clone().multiplyScalar(-i * 0.2));
                        const offset = side.clone().multiplyScalar(amplitude * Math.sin(i * 2 + wavePhase));
                        pointOnLine.add(offset);
                        positions.setXYZ(i, pointOnLine.x, pointOnLine.y, pointOnLine.z);
                    }

                    const newDist = ray.position.length();
                    let hue = newDist < ray.prevDist ? 0.66 : (0.16 * Math.max(0, 1 - (rs*1.5 / r)));
                    ray.prevDist = newDist;
                    
                    const color = new THREE.Color();
                    const colors = ray.line.geometry.attributes.color || new THREE.BufferAttribute(new Float32Array(NUM_WAVE_POINTS * 3), 3);
                    for(let i = 0; i < NUM_WAVE_POINTS; i++){
                        const fade = 1.0 - (i / NUM_WAVE_POINTS);
                        color.setHSL(hue, 0.9, 0.6);
                        colors.setXYZ(i, color.r, color.g, color.b);
                    }
                    ray.line.geometry.setAttribute('color', colors);
                    positions.needsUpdate = true;
                    if(colors) colors.needsUpdate = true;
                });
            }
            if (entropyViewVisible) {
                entropyParticles.scale.setScalar(rs > 0 ? rs : 0.1);
                const positions = entropyParticles.geometry.attributes.position;
                const colors = entropyParticles.geometry.attributes.color;
                const particleCountToDraw = Math.min(MAX_ENTROPY_PARTICLES, entropyParticleCount);
                entropyParticles.geometry.setDrawRange(0, particleCountToDraw);
                
                const tempColor = new THREE.Color();
                const repulsionForce = new THREE.Vector3();
                
                for(let i = 0; i < particleCountToDraw; i++) {
                    const p = entropyParticleData[i];

                    // Gravity
                    const gravity = p.position.clone().normalize().multiplyScalar(-0.01 * systemEnergy);
                    p.velocity.add(gravity);
                    
                    // Simple repulsion from a few neighbors to avoid O(n^2)
                    for(let j=0; j<3; j++) {
                        const other_idx = (i + Math.floor(1 + Math.random() * (particleCountToDraw-1))) % particleCountToDraw;
                        const p2 = entropyParticleData[other_idx];
                        const distSq = p.position.distanceToSquared(p2.position);
                        if (distSq < 0.1 && distSq > 0.0001) {
                            repulsionForce.subVectors(p.position, p2.position).normalize().multiplyScalar(0.001 / distSq);
                            p.velocity.add(repulsionForce);
                        }
                    }

                    p.velocity.multiplyScalar(0.95); // Damping
                    p.position.add(p.velocity.clone().multiplyScalar(delta * 10));
                    p.position.normalize(); // Keep on sphere surface
                    
                    positions.setXYZ(i, p.position.x, p.position.y, p.position.z);
                    
                    const hue = (time * 0.05 + p.position.x + p.position.y) % 1;
                    tempColor.setHSL(hue, 0.9, 0.6);
                    colors.setXYZ(i, tempColor.r, tempColor.g, tempColor.b);
                }
                positions.needsUpdate = true;
                colors.needsUpdate = true;
            }
        }

        createControls();
        return { update, cleanup: () => {}, followTarget: centralObject };
    }
    
    function onWindowResize() { 
        camera.aspect = window.innerWidth / window.innerHeight; 
        camera.updateProjectionMatrix(); 
        renderer.setSize(window.innerWidth, window.innerHeight); 
    }

    function updateCameraFollow() {
        if(followMode && followObject && !entropyViewVisible) {
            const distance = followObject.scale.x * 10 + 25;
            const offset = controls.target.clone().sub(camera.position).normalize().multiplyScalar(distance);
            const targetPosition = followObject.position.clone().sub(offset);
            const targetContainer = renderer.xr.isPresenting ? playerDolly : camera;
            targetContainer.position.lerp(targetPosition, 0.1);
            if (!renderer.xr.isPresenting) controls.target.lerp(followObject.position, 0.1);
        }
    }

    function updateVRInputs() {
        if (!renderer.xr.isPresenting) return;
        const deadzone = 0.15;
        const updateControllerState = (controller, state) => {
            if (controller && controller.gamepad) {
                const gp = controller.gamepad;
                state.trigger.pressed = gp.buttons[0]?.pressed;
                state.grip.pressed = gp.buttons[1]?.pressed;
                state.thumbstick.x = Math.abs(gp.axes[2]) > deadzone ? gp.axes[2] : 0;
                state.thumbstick.y = Math.abs(gp.axes[3]) > deadzone ? gp.axes[3] : 0;
            }
        };
        updateControllerState(controller1, vrInputs.left);
        updateControllerState(controller2, vrInputs.right);
    }

    function handleDesktopFlyControls(delta) {
        if (!flyModeEnabled || renderer.xr.isPresenting) return;
        
        const speed = flySpeed * delta;
        const forward = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
        const right = new THREE.Vector3(1, 0, 0).applyQuaternion(camera.quaternion);
        const moveDirection = new THREE.Vector3(0, 0, 0);

        if (keyState['KeyW'] || keyState['ArrowUp']) moveDirection.add(forward);
        if (keyState['KeyS'] || keyState['ArrowDown']) moveDirection.sub(forward);
        if (keyState['KeyA'] || keyState['ArrowLeft']) moveDirection.sub(right);
        if (keyState['KeyD'] || keyState['ArrowRight']) moveDirection.add(right);
        if (keyState['Space']) moveDirection.y += 1;
        if (keyState['ShiftLeft']) moveDirection.y -= 1;

        if (moveDirection.lengthSq() > 0) {
            const moveVector = moveDirection.normalize().multiplyScalar(speed);
            camera.position.add(moveVector);
        }
    }

    function handleVRControllers(delta) {
        if (!renderer.xr.isPresenting) return;
        
        const speed = 3.0;
        const turnSpeed = 1.5;
        const cameraDirection = new THREE.Quaternion();
        camera.getWorldQuaternion(cameraDirection);

        const moveDirection = new THREE.Vector3(vrInputs.left.thumbstick.x, 0, vrInputs.left.thumbstick.y);
        if (moveDirection.length() > 0.1) {
            moveDirection.normalize().multiplyScalar(speed * delta);
            const flatCameraQuaternion = new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0, 1, 0), new THREE.Euler().setFromQuaternion(cameraDirection).y);
            moveDirection.applyQuaternion(flatCameraQuaternion);
            playerDolly.position.add(moveDirection);
        }

        if (Math.abs(vrInputs.right.thumbstick.x) > 0.1) {
            playerDolly.rotation.y -= vrInputs.right.thumbstick.x * turnSpeed * delta;
        }
        if (Math.abs(vrInputs.right.thumbstick.y) > 0.1) {
            playerDolly.position.y -= vrInputs.right.thumbstick.y * speed * delta;
        }

        const bothGripsPressed = vrInputs.left.grip.pressed && vrInputs.right.grip.pressed;
        if (bothGripsPressed && !vrInputs.isZooming) {
            vrInputs.isZooming = true;
            vrInputs.initialZoomDistance = controllerGrip1.position.distanceTo(controllerGrip2.position);
            vrInputs.initialDollyScale.copy(playerDolly.scale);
        } else if (bothGripsPressed && vrInputs.isZooming) {
            const currentDistance = controllerGrip1.position.distanceTo(controllerGrip2.position);
            if (vrInputs.initialZoomDistance > 0.01) {
                const scaleFactor = currentDistance / vrInputs.initialZoomDistance;
                const newScale = vrInputs.initialDollyScale.clone().multiplyScalar(scaleFactor);
                newScale.clampScalar(0.1, 10.0);
                playerDolly.scale.copy(newScale);
            }
        } else if (!bothGripsPressed && vrInputs.isZooming) {
            vrInputs.isZooming = false;
        }
    }

    function animate() { 
        const delta = clock.getDelta();
        
        updateVRInputs();
        handleDesktopFlyControls(delta);

        if (controls.enabled) {
            controls.update(); 
        }
        
        if(!isPaused && currentUpdate) {
            currentUpdate(delta); 
        } else {
            // Even if paused, we might need to update visuals if a toggle was changed
            renderer.render(scene, camera);
        }
        
        handleVRControllers(delta);
        updateCameraFollow();
        renderer.render(scene, camera); 
    }
    
    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Interactive Black Hole Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
            background-color: #030712; /* bg-gray-950 */
            color: #e5e7eb;
        }
        .ui-panel {
            position: absolute;
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(8px);
            padding: 1.25rem;
            border: 1px solid rgba(55, 65, 81, 0.7);
            transition: all 0.5s ease-in-out;
            z-index: 10;
        }
        #info-panel {
            top: 80px;
            left: 20px;
            max-width: 420px;
            cursor: pointer;
            overflow: hidden;
            border-radius: 12px;
            max-height: 58px; /* Collapsed */
        }
        #info-panel.expanded {
            max-height: 90vh; 
            cursor: default;
            overflow-y: auto;
            z-index: 11;
        }
        #info-header { display: flex; justify-content: space-between; align-items: center; }
        #toggle-icon { transition: transform 0.3s ease-in-out; }
        #info-panel.expanded #toggle-icon { transform: rotate(180deg); }
        .formula {
            font-family: 'Georgia', serif;
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 1.2rem;
            margin-top: 1rem;
            color: #d1d5db;
            border: 1px solid #374151;
            overflow-x: auto;
        }
        #metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #374151;
        }
        #metrics-grid > div {
            text-align: center;
        }
        #controls-panel {
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
        }
        header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            display: flex;
            justify-content: center; /* Centered title */
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: rgba(3, 7, 18, 0.5);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(55, 65, 81, 0.7);
        }
        .toggle-button {
            background-color: rgba(55, 65, 81, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(75, 85, 99, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .toggle-button:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .toggle-button.active {
            background-color: #4f46e5;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #4b5563;
            border-radius: 2px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #818cf8;
            cursor: pointer;
            border-radius: 50%;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        .hidden { display: none !important; }
        canvas { display: block; cursor: grab; }
        canvas:active { cursor: grabbing; }
        body.fly-mode-active canvas { cursor: crosshair; }

        #fly-mode-warning {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 237, 113, 0.2); /* yellow-200 with opacity */
            color: #fef08a; /* yellow-200 */
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid rgba(250, 204, 21, 0.4);
            z-index: 21;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #speed-indicator {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(17, 24, 39, 0.85);
            color: #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid rgba(55, 65, 81, 0.7);
            z-index: 21;
            pointer-events: none;
            transition: opacity 0.3s ease;
            opacity: 0; /* Start hidden */
        }
        #speed-indicator.visible {
            opacity: 1;
        }

        /* Toggle Switch CSS */
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 28px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #374151; /* gray-700 */
          transition: .4s;
          border-radius: 28px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: #4f46e5; /* indigo-600 */
        }
        input:checked + .slider:before {
          transform: translateX(22px);
        }

        #settings-button, #fullscreen-button {
            position: absolute;
            background-color: rgba(55, 65, 81, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(75, 85, 99, 0.9);
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        #settings-button {
            top: 80px;
            right: 20px;
            z-index: 11;
        }
        #fullscreen-button {
            bottom: 120px;
            right: 20px;
            z-index: 11;
        }
        #settings-button:hover {
            background-color: #4338ca;
            transform: translateY(-2px) rotate(45deg);
        }
        #fullscreen-button:hover {
             background-color: #4338ca;
            transform: translateY(-2px) scale(1.1);
        }
        #settings-panel {
            top: 80px;
            right: 0;
            width: 300px;
            max-width: 90vw;
            border-radius: 12px 0 0 12px;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding-right: 2rem; 
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            z-index: 12;
        }
        #settings-panel.open { transform: translateX(0); }
        #close-settings {
            font-size: 2.5rem;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
            cursor: pointer;
        }
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 40px;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch { border-radius: 8px; border: 1px solid #4b5563; }
        input[type="color"]::-moz-color-swatch { border-radius: 8px; border: 1px solid #4b5563; }

        body.fullscreen-active header,
        body.fullscreen-active #info-panel { display: none !important; }

        body.fullscreen-active #controls-panel,
        body.fullscreen-active #settings-button,
        body.fullscreen-active #fullscreen-button {
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        body.fullscreen-active #controls-panel.show-on-hover,
        body.fullscreen-active #settings-button.show-on-hover,
        body.fullscreen-active #fullscreen-button.show-on-hover {
            opacity: 1;
            pointer-events: auto;
            visibility: visible;
        }
        
        @media (max-width: 768px) {
            header { padding: 0.75rem 1rem; }
            header h1 { font-size: 1.125rem; }
            #info-panel { top: 70px; left: 10px; right: 10px; max-width: none; width: auto; }
            #settings-button { top: 70px; right: 10px; }
            #fullscreen-button { bottom: 100px; right: 10px; }
            #settings-panel { top: 70px; width: 280px; max-height: calc(100vh - 80px);}
            #controls-panel { padding: 0.75rem; gap: 0.75rem; justify-content: space-around; }
            .control-group { gap: 0.25rem; }
            #controls-panel .text-3xl { font-size: 1.5rem; }
            #controls-panel label, #controls-panel .text-sm, #controls-panel .text-xs { font-size: 0.75rem; }
            input[type="range"]::-webkit-slider-thumb { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="text-xl font-bold text-gray-200 tracking-wider opacity-90">Black Hole Simulator</h1>
    </header>

    <div id="fly-mode-warning" class="hidden">Press [ESC] or Right-Click to release controls</div>
    <div id="speed-indicator">Speed: 1.0x</div>

    <div id="info-panel" class="ui-panel">
        <div id="info-header">
            <h2 id="info-title" class="text-xl font-bold text-indigo-400">Black Hole Simulator</h2>
            <div id="toggle-icon" class="text-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
        </div>
        <div id="info-content" class="pt-4 space-y-3">
             <p id="info-description" class="text-gray-300">This simulation visualizes how mass-energy ($T_{\mu\nu}$) curves spacetime according to Einstein's Field Equations. You can control the mass of the central object and observe its effects on the surrounding fabric of spacetime, particles, and light rays.</p>
             <div id="info-formula" class="formula">G<sub>&mu;&nu;</sub> = R<sub>&mu;&nu;</sub> - &frac12;R g<sub>&mu;&nu;</sub> = (8&pi;G/c<sup>4</sup>)T<sub>&mu;&nu;</sub></div>
             <div id="blackhole-explanation-content">
                 <h3 class="font-bold text-lg text-purple-400 mt-4">Visualizing Spacetime</h3>
                 <p class="text-sm text-gray-300">The grid represents the fabric of spacetime, which is distorted by the mass of the central object. The flowing particles represent matter following "geodesics"—the straightest possible paths through this curved space.</p>
             </div>
             <div id="entropy-explanation-content">
                <h3 class="font-bold text-lg text-amber-400 mt-4">The Holographic Principle</h3>
                <p class="text-sm text-gray-300">The "Entropy View" visualizes the idea that a black hole's entropy—a measure of its internal information or "states"—is proportional to its surface area. The shimmering particles on the event horizon represent this encoded information. These states interact with each other, creating a dynamic "boiling" surface bound by the black hole's gravity.</p>
            </div>
             <div id="metrics-grid">
                <div> <div class="text-xs text-purple-400">Entropy (S/k<sub>B</sub>)</div> <div id="bh-entropy-value" class="text-lg font-bold">...</div> </div>
                <div> <div class="text-xs text-purple-400">Object Radius</div> <div id="rs-value" class="text-lg font-bold">...</div> </div>
                <div> <div class="text-xs text-purple-400">Surface Gravity (κ)</div> <div id="kappa-value" class="text-lg font-bold">...</div> </div>
                <div> <div class="text-xs text-purple-400">κ / c Ratio</div> <div id="ratio-value" class="text-lg font-bold">...</div> </div>
                <div class="col-span-1 md:col-span-2"> <div class="text-xs text-purple-400">Lorentz Factor (γ) at R<sub>S</sub></div> <div id="lorentz-value" class="text-lg font-bold">...</div> </div>
            </div>
        </div>
    </div>

    <div id="controls-panel" class="ui-panel"></div>

    <button id="fullscreen-button" title="Toggle Fullscreen">
        <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
        </svg>
        <svg id="fullscreen-exit-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/>
        </svg>
    </button>
    <button id="settings-button" title="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
    </button>
    
    <div id="settings-panel" class="ui-panel hidden">
        <div class="flex justify-between items-center mb-6 sticky top-0 bg-inherit z-10 py-2">
            <h3 class="text-xl font-bold text-gray-200">Settings</h3>
            <button id="close-settings" class="text-gray-400 hover:text-white transition-colors">&times;</button>
        </div>
        <div class="space-y-6">
            <div class="control-group text-left w-full">
                <label class="text-sm font-medium self-start w-full">VR Mode</label>
                <button id="vr-button" title="Enter VR Mode" class="toggle-button w-full flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12.3C2 7.8 5.8 4 10.3 4s8.3 3.8 8.3 8.3-3.5 8.3-8.3 8.3S2 16.8 2 12.3z"/>
                        <path d="M12.3 4a8.3 8.3 0 0 1 8.3 8.3 8.3 8.3 0 0 1-8.3 8.3"/>
                    </svg>
                    <span>Enter VR</span>
                </button>
            </div>
            <div class="control-group text-left w-full">
                <label class="text-sm font-medium self-start w-full">Follow Object</label>
                <button id="follow-toggle" class="toggle-button">Off</button>
            </div>
            <div class="control-group text-left w-full">
                <label for="light-speed-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Light Speed / Time Flow:</span>
                    <span id="light-speed-value">999x</span>
                </label>
                <input id="light-speed-slider" type="range" min="0.1" max="1000" step="1" value="999" class="w-full">
            </div>
            <div class="control-group text-left w-full">
                <label for="trace-length-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Light Ray Trace Length:</span>
                    <span id="trace-length-value">40</span>
                </label>
                <input id="trace-length-slider" type="range" min="5" max="100" step="1" value="40" class="w-full">
            </div>
            <div id="blackhole-spin-control" class="control-group text-left w-full">
                <label for="spin-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Black Hole Spin:</span>
                    <span id="spin-value">0.00</span>
                </label>
                <input id="spin-slider" type="range" min="0" max="0.99" step="0.01" value="0.0" class="w-full">
            </div>
            <div class="control-group text-left w-full">
                <label for="particle-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Particle Count:</span>
                    <span id="particle-count-value">5000</span>
                </label>
                <input id="particle-slider" type="range" min="100" max="20000" step="100" value="5000" class="w-full">
            </div>
             <div class="control-group text-left w-full">
                <label for="entropy-particle-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Entropy Particle Count:</span>
                    <span id="entropy-particle-count-value">10000</span>
                </label>
                <input id="entropy-particle-slider" type="range" min="100" max="30000" step="100" value="10000" class="w-full">
            </div>
            <div class="control-group text-left w-full">
                <label for="energy-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>System Energy (Temp):</span>
                    <span id="energy-value">1.0x</span>
                </label>
                <input id="energy-slider" type="range" min="0.1" max="5" step="0.1" value="1.0" class="w-full">
            </div>
            <div class="control-group text-left w-full">
                <label for="particle-size-slider" class="text-sm font-medium self-start w-full flex justify-between">
                    <span>Particle Size
