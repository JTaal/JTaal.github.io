<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyodide - VS Code IDE</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Xterm.js -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    
    <!-- JSZip for downloading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>

    <!-- Pyodide (loaded in worker) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        :root {
            --vscode-bg: #1e1e1e;
            --sidebar-bg: #252526;
            --activity-bar-bg: #333333;
            --statusbar-bg: #007acc;
            --border-color: #3c3c3c;
            --foreground: #cccccc;
            --blue-accent: #007acc;
            --tab-inactive-bg: #2d2d2d;
            --tab-active-bg: #1e1e1e;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: var(--foreground); background-color: var(--vscode-bg); overflow: hidden; }
        .vscode-layout { display: grid; grid-template-columns: 50px auto; grid-template-rows: 1fr 25px; height: 100vh; width: 100vw; }
        .activity-bar { grid-column: 1; grid-row: 1 / 3; background-color: var(--activity-bar-bg); display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 10px 0; z-index: 50; }
        .activity-bar-top { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .activity-bar svg { width: 28px; height: 28px; cursor: pointer; padding: 4px; border-radius: 4px; }
        .activity-bar svg.active { background-color: var(--blue-accent); }
        .main-content { grid-column: 2; grid-row: 1; display: flex; background-color: var(--vscode-bg); overflow: hidden; }
        .side-panel { width: 300px; min-width: 200px; max-width: 80%; height: 100%; background-color: var(--sidebar-bg); display: flex; flex-direction: column; transition: min-width 0.2s, width 0.2s; overflow: auto; flex-shrink: 0; }
        .side-panel.hidden { width: 0; min-width: 0; padding: 0; border-right: none; overflow: hidden; }
        #sidebar-resizer { width: 5px; cursor: col-resize; background: var(--border-color); flex-shrink: 0; }
        .panel-section { padding: 0 10px; border-bottom: 1px solid var(--border-color); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .panel-header h3 { font-weight: bold; }
        .panel-header .actions button { background: none; border: none; color: var(--foreground); cursor: pointer; padding: 2px; border-radius: 3px; }
        .panel-header .actions button:hover { background-color: #3c3c3c; }
        #file-explorer { flex-grow: 1; overflow-y: auto; padding-bottom: 10px; min-height: 50px; transition: background-color 0.2s; }
        #file-explorer.drag-over-root { background-color: #2a2a2d; }
        #package-installer-container { flex-grow: 1; overflow-y: auto; padding-bottom: 10px; }
        #file-explorer ul { padding-left: 20px; } /* Indentation for nested items */
        #file-explorer > ul { padding-left: 0; } /* No indent for root */
        #file-explorer li { list-style: none; }
        .file-row { padding: 2px 4px; cursor: pointer; display: flex; align-items: center; gap: 5px; border-radius: 3px; }
        .file-row:hover, .file-row.active { background-color: #2a2a2d; }
        .file-row.drag-over { background-color: var(--blue-accent); }
        .editor-terminal-container { flex-grow: 1; display: flex; flex-direction: column; min-width: 0; }
        #tab-bar { display: flex; flex-grow: 1; background-color: var(--sidebar-bg); flex-shrink: 1; overflow-x: auto; }
        .tab { display: flex; align-items: center; padding: 8px 10px; background-color: var(--tab-inactive-bg); border-right: 1px solid var(--border-color); cursor: pointer; font-size: 14px; flex-shrink: 0; }
        .tab.active { background-color: var(--tab-active-bg); }
        .tab .close-btn { margin-left: 10px; padding: 2px; border-radius: 3px; }
        .tab .close-btn:hover { background-color: #3c3c3c; }
        #editor-container { flex-grow: 1; overflow: hidden; border-bottom: 1px solid var(--border-color); }
        #script-editor { width: 100%; height: 100%; }
        #terminal-container { height: 35%; min-height: 50px; padding: 5px; } #terminal { width: 100%; height: 100%; }
        #resizer { cursor: ns-resize; height: 5px; background: var(--border-color); width: 100%; flex-shrink: 0; }
        .status-bar { grid-column: 1 / 3; grid-row: 2; background-color: var(--statusbar-bg); color: white; display: flex; align-items: center; padding: 0 15px; font-size: 12px; z-index: 100; }
        .package-btn.installed { background-color: #315d66 !important; cursor: default !important; color: #a0d9e2; }
    </style>
</head>
<body>

    <div class="vscode-layout">
        <!-- ACTIVITY BAR -->
        <div class="activity-bar">
            <div class="activity-bar-top">
                <svg id="toggle-files-btn" class="active" fill="white" viewBox="0 0 24 24"><title>Toggle Explorer</title><path d="M6,2h6l2,2h6c1.1,0,2,0.9,2,2v12c0,1.1-0.9,2-2,2H6c-1.1,0-2-0.9-2-2V4C4,2.9,4.9,2,6,2z"/></svg>
                <svg id="run-script-btn" fill="white" viewBox="0 0 24 24"><title>Run Active File</title><path d="M8,5v14l11-7L8,5z"/></svg>
                <svg id="download-project-btn" fill="white" viewBox="0 0 24 24"><title>Download Project as .zip</title><path d="M19,9h-4V3H9v6H5l7,7L19,9z M5,18v2h14v-2H5z"/></svg>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SIDE PANEL -->
            <div id="side-panel" class="side-panel">
                <div class="panel-section">
                    <div class="panel-header">
                        <h3>EXPLORER</h3>
                        <div class="actions">
                            <div id="action-buttons-container">
                                <button id="new-file-btn" title="New File">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/></svg>
                                </button>
                                <button id="new-folder-btn" title="New Folder">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM6.172 2h-3.37a1 1 0 0 0-.996.966l.637 7a1 1 0 0 0 .995.934h10.348a1 1 0 0 0 .995.934l.637-7a1 1 0 0 0-.996-.966H9.828a1 1 0 0 1-.707-.293L8.354 2.854A1 1 0 0 0 7.646 2.56H6.172z"/></svg>
                                </button>
                            </div>
                            <div id="creation-input-container" class="hidden flex items-center">
                                <span id="creation-icon-span" class="mr-1"></span>
                                <input type="text" id="creation-input" class="bg-gray-700 border-gray-600 border px-1 w-40 text-sm focus:outline-none rounded-sm">
                           </div>
                        </div>
                    </div>
                    <div id="file-explorer"></div>
                </div>
                 <div class="panel-section" id="package-installer-container">
                    <div class="panel-header"><h3>PACKAGES</h3></div>
                    <p class="text-xs font-bold mt-2 mb-1">Quick Install</p>
                    <div id="package-buttons" class="flex flex-wrap gap-2 mb-3"></div>
                    <p class="text-xs font-bold mt-4 mb-1">PyPI Search</p>
                    <input type="text" id="pypi-search-input" class="w-full bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-cyan-500" placeholder="Search and press Enter...">
                    <div id="pypi-search-results" class="flex flex-wrap gap-2 mt-2"></div>
                    <p class="text-xs font-bold mt-4 mb-1">From File</p>
                    <button id="upload-requirements-btn" class="w-full px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md transition-colors">Upload requirements.txt</button>
                    <input type="file" id="requirements-input" class="hidden" accept=".txt">
                </div>
            </div>
            <div id="sidebar-resizer"></div>
            <!-- EDITOR & TERMINAL -->
            <div class="editor-terminal-container">
                <div class="flex justify-between" style="background-color: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);">
                    <div id="tab-bar"></div>
                    <div id="tab-bar-actions" class="flex items-center pr-2 flex-shrink-0">
                        <button id="tab-run-btn" title="Run Active File">
                            <svg class="w-6 h-6 text-green-500 hover:text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="editor-container"><div id="script-editor"></div></div>
                <div id="resizer"></div>
                <div id="terminal-container"><div id="terminal"></div></div>
            </div>
        </div>
        <!-- STATUS BAR -->
        <div id="status-bar" class="status-bar"><span>Pyodide: Loading environment...</span></div>
    </div>

    <script type="module">
        // --- DATA & STATE ---
        let fileSystem = {
            "main.py": { type: "file", content: `# Welcome to your Python IDE!\n# 1. Create files and folders on the left.\n# 2. Run 'pip install <package>' in the terminal.\n# 3. The 'Run' button executes the currently active file.\n\nimport cowsay\ncowsay.cow('Hello from Pyodide!')\n` },
            "data": { type: "folder", children: { "sample.txt": { type: "file", content: "This is some sample data." } }}
        };
        let openFiles = ['main.py'];
        let activeFile = "main.py";
        let installedPackages = new Set();
        let isWorkerReady = false;
        let isExecuting = false;
        let monacoEditor;
        let expandedFolders = new Set(['data']);
        
        // --- ICONS ---
        const icons = {
            folder: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-blue-400 flex-shrink-0" viewBox="0 0 16 16"><path d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM6.172 2h-3.37a1 1 0 0 0-.996.966l.637 7a1 1 0 0 0 .995.934h10.348a1 1 0 0 0 .995.934l.637-7a1 1 0 0 0-.996-.966H9.828a1 1 0 0 1-.707-.293L8.354 2.854A1 1 0 0 0 7.646 2.56H6.172z"/></svg>`,
            file: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-gray-400 flex-shrink-0" viewBox="0 0 16 16"><path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/></svg>`,
            chevronRight: `<svg class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M6 4l4 4-4 4z"/></svg>`,
            chevronDown: `<svg class="flex-shrink-0" width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 11L4 7h8l-4 4z"/></svg>`
        };

        // --- WEB WORKER ---
        const worker = new Worker(URL.createObjectURL(new Blob([`
            importScripts("https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js");
            let pyodide;
            async function setupPyodide(){ 
                pyodide = await loadPyodide(); 
                pyodide.setStdout({ batched: (str) => self.postMessage({ type: 'stdout', data: str }) }); 
                pyodide.setStderr({ batched: (str) => self.postMessage({ type: 'stderr', data: str }) }); 
                await pyodide.loadPackage("micropip"); 
                pyodide.runPython(\`
                    import micropip
                    import os, sys
                    async def install(package): 
                        await micropip.install(package)
                        return f"Successfully installed {package}"
                    
                    def run_script_code(path, code):
                        full_path = os.path.abspath(path)
                        script_dir = os.path.dirname(full_path)
                        original_cwd = os.getcwd()
                        original_sys_path = list(sys.path)
                        try:
                            if os.path.isdir(script_dir):
                                os.chdir(script_dir)
                            
                            if script_dir not in sys.path:
                                sys.path.insert(0, script_dir)
                            
                            script_globals = {
                                "__name__": "__main__",
                                "__file__": full_path,
                            }
                            exec(code, script_globals)
                        finally:
                            os.chdir(original_cwd)
                            sys.path[:] = original_sys_path
                \`); 
                self.postMessage({ type: 'ready' }); 
            }
            const pyodideReadyPromise = setupPyodide();
            const syncFSToPyodide = (fs) => { 
                function _walk(path, node) { 
                    for (const [name, child] of Object.entries(node)) { 
                        const currentPath = path ? \`\${path}/\${name}\` : name; 
                        if (child.type === 'folder') { 
                            try { pyodide.FS.mkdirTree(currentPath); } catch(e){} 
                            _walk(currentPath, child.children); 
                        } else { 
                            pyodide.FS.writeFile(currentPath, child.content, { encoding: 'utf8' }); 
                        } 
                    } 
                } 
                _walk('', fs); 
            };
            self.onmessage = async (event) => { 
                await pyodideReadyPromise; 
                let success = true;
                const { type, payload } = event.data; 
                try { 
                    switch(type) { 
                        case 'syncFS': 
                            syncFSToPyodide(payload); 
                            break; 
                        case 'pip':
                            const result = await pyodide.globals.get('install')(payload);
                            self.postMessage({ type: 'stdout', data: result });
                            break; 
                        case 'script': 
                            const { path, code } = payload;
                            pyodide.globals.get('run_script_code')(path, code); 
                            break; 
                        case 'terminal': 
                            const resultEval = await pyodide.runPythonAsync(payload); 
                            if (resultEval !== undefined) { 
                                const reprResult = pyodide.globals.get('repr')(resultEval); 
                                self.postMessage({ type: 'stdout', data: reprResult }); 
                            } 
                            break; 
                    } 
                } catch (err) { 
                    success = false; 
                    self.postMessage({ type: 'stderr', data: err.toString() }); 
                } finally { 
                    self.postMessage({ type: 'complete', commandType: type, packageName: payload, success: success }); 
                } 
            };
        `], { type: 'application/javascript' })));

        // --- UI & DOM ---
        const fileExplorerDiv = document.getElementById('file-explorer');
        const statusBar = document.getElementById('status-bar').querySelector('span');
        const tabBar = document.getElementById('tab-bar');
        const prompt = '\r\n\x1b[1;32m>>> \x1b[0m';
        let currentCommand = '';
        
        // --- MONACO EDITOR ---
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs' }});
        window.MonacoEnvironment = { getWorkerUrl: () => `data:text/javascript;charset=utf-8,${encodeURIComponent(`self.MonacoEnvironment={baseUrl:'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/'};importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/base/worker/workerMain.js');`)}` };
        
        require(["vs/editor/editor.main"], () => {
            monacoEditor = monaco.editor.create(document.getElementById('script-editor'), { theme: 'vs-dark', automaticLayout: true, minimap: { enabled: false } });
            openFile(activeFile);
            monacoEditor.onDidChangeModelContent(saveCurrentFile);
        });

        // --- UI RENDERING ---
        function renderTabs() {
            tabBar.innerHTML = '';
            openFiles.forEach(path => {
                const tab = document.createElement('div');
                tab.className = 'tab' + (path === activeFile ? ' active' : '');
                const fileName = path.split('/').pop();
                tab.innerHTML = `<span>${fileName}</span><span class="close-btn">×</span>`;
                tab.addEventListener('click', () => openFile(path));
                tab.querySelector('.close-btn').addEventListener('click', (e) => { e.stopPropagation(); closeFile(path); });
                tabBar.appendChild(tab);
            });
        }

        function renderFileExplorer() {
            fileExplorerDiv.innerHTML = '';
            const tree = document.createElement('ul');
            fileExplorerDiv.appendChild(tree);
            createTree(fileSystem, '', tree);
        }
        
        // --- FILE & FOLDER LOGIC ---
        function createTree(node, path, element) {
            const entries = Object.entries(node).sort(([aName, a], [bName, b]) => (a.type !== b.type) ? (a.type === 'folder' ? -1 : 1) : aName.localeCompare(bName));
            entries.forEach(([name, child]) => {
                const currentPath = path ? `${path}/${name}` : name;
                const li = document.createElement('li');
                li.dataset.path = currentPath;
                
                const row = document.createElement('div');
                row.className = 'file-row';
                row.draggable = true;
                row.addEventListener('dragstart', (e) => { e.stopPropagation(); handleDragStart(e, currentPath); });
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragleave', handleDragLeave);
                li.addEventListener('drop', (e) => { e.stopPropagation(); handleDrop(e, currentPath); });

                if (child.type === 'folder') {
                    const isExpanded = expandedFolders.has(currentPath);
                    row.innerHTML = `${isExpanded ? icons.chevronDown : icons.chevronRight}${icons.folder}<span class="truncate">${name}</span>`;
                    row.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        expandedFolders.has(currentPath) ? expandedFolders.delete(currentPath) : expandedFolders.add(currentPath); 
                        renderFileExplorer(); 
                    });
                    li.appendChild(row);

                    if (isExpanded) { 
                        const ul = document.createElement('ul'); 
                        li.appendChild(ul); 
                        createTree(child.children, currentPath, ul); 
                    }
                } else {
                    row.innerHTML = `<span class="w-4 inline-block"></span>${icons.file}<span class="truncate">${name}</span>`;
                    if (currentPath === activeFile) {
                        row.classList.add('active');
                    }
                    row.addEventListener('click', (e) => { e.stopPropagation(); openFile(currentPath); });
                    li.appendChild(row);
                }
                element.appendChild(li);
            });
        }
        
        function getNodeFromPath(path) {
            if (!path) return null;
            const parts = path.split('/');
            let node = fileSystem;
            for (const part of parts) {
                if (!part) continue;
                const nextNode = (node.type === 'folder') ? node.children[part] : node[part];
                if (!nextNode) return null;
                node = nextNode;
            }
            return node;
        }

        function getParentAndNodeFromPath(path) {
            const parts = path.split('/');
            const name = parts.pop();
            if (parts.length === 0) {
                return { parent: { children: fileSystem }, node: fileSystem[name], name };
            }
            const parentPath = parts.join('/');
            const parent = getNodeFromPath(parentPath);
            if (!parent || parent.type !== 'folder') return { parent: null, node: null, name };
            return { parent, node: parent.children[name], name };
        }

        function saveCurrentFile() {
            if (!activeFile || !monacoEditor) return;
            const node = getNodeFromPath(activeFile);
            if (node?.type === 'file') {
                 node.content = monacoEditor.getValue();
            }
        }

        function openFile(path) {
            const node = getNodeFromPath(path);
            if (!path || !node || node.type !== 'file') return;
            
            activeFile = path;
            if (!openFiles.includes(path)) {
                openFiles.push(path);
            }
            
            if (monacoEditor) {
                if (monacoEditor.getValue() !== node.content) {
                    monacoEditor.setValue(node.content);
                }
                const model = monacoEditor.getModel();
                if (model) {
                    monaco.editor.setModelLanguage(model, path.endsWith('.py') ? 'python' : 'plaintext');
                }
            }
            renderFileExplorer();
            renderTabs();
        }

        function closeFile(path) {
            const index = openFiles.indexOf(path);
            if (index > -1) {
                openFiles.splice(index, 1);
            }

            if (activeFile === path) {
                activeFile = openFiles[index] || openFiles[index - 1] || null;
                if (activeFile) {
                    openFile(activeFile); 
                } else {
                    if (monacoEditor) {
                        monacoEditor.setValue('');
                    }
                    renderFileExplorer();
                }
            }
            renderTabs();
        }

        function showCreationInput(type) {
            const actionButtonsContainer = document.getElementById('action-buttons-container');
            const creationContainer = document.getElementById('creation-input-container');
            const creationInput = document.getElementById('creation-input');
            const creationIconSpan = document.getElementById('creation-icon-span');
            
            actionButtonsContainer.classList.add('hidden');
            creationContainer.classList.remove('hidden');
            creationIconSpan.innerHTML = type === 'folder' ? icons.folder : icons.file;
            creationInput.value = '';
            creationInput.focus();
            
            const cleanup = () => {
                creationContainer.classList.add('hidden');
                actionButtonsContainer.classList.remove('hidden');
                creationInput.removeEventListener('blur', commit);
                creationInput.removeEventListener('keydown', handleKey);
            };

            const commit = () => {
                const name = creationInput.value.trim();
                // For simplicity, creating at root. A real implementation would handle context.
                if (name && !fileSystem[name]) {
                    fileSystem[name] = type === 'folder' ? { type: 'folder', children: {} } : { type: 'file', content: '' };
                    if (type === 'file') {
                        openFile(name);
                    } else {
                        expandedFolders.add(name);
                        renderFileExplorer();
                    }
                }
                cleanup();
            };

            const handleKey = (e) => {
                if (e.key === 'Enter') { e.preventDefault(); commit(); } 
                else if (e.key === 'Escape') { cleanup(); }
            };

            creationInput.addEventListener('blur', commit, { once: true });
            creationInput.addEventListener('keydown', handleKey);
        }
        
        // --- DRAG & DROP ---
        function handleDragStart(e, path) { e.dataTransfer.setData('text/plain', path); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragOver(e) { e.preventDefault(); e.target.closest('.file-row')?.classList.add('drag-over'); }
        function handleDragLeave(e) { e.target.closest('.file-row')?.classList.remove('drag-over'); }
        function handleDrop(e, dropOntoPath) {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const sourcePath = e.dataTransfer.getData('text/plain');
            
            let targetPath = dropOntoPath;
            let targetNode = getNodeFromPath(targetPath);

            if (targetNode && targetNode.type === 'file') {
                const parts = targetPath.split('/');
                parts.pop();
                targetPath = parts.join('/');
                targetNode = getNodeFromPath(targetPath);
            }

            if (targetPath === '') {
                targetNode = { children: fileSystem, type: 'folder' };
            }

            if (!targetNode || targetNode.type !== 'folder') return;
            if (sourcePath === targetPath || (targetPath && targetPath.startsWith(sourcePath + '/'))) return;
            
            const sourceInfo = getParentAndNodeFromPath(sourcePath);
            if (!sourceInfo.node) return;

            targetNode.children[sourceInfo.name] = sourceInfo.node;
            delete sourceInfo.parent.children[sourceInfo.name];

            const newPath = targetPath ? `${targetPath}/${sourceInfo.name}` : sourceInfo.name;
            const updatePath = (arr, oldPrefix, newPrefix) => {
                arr.forEach((p, i) => { if (p === oldPrefix || p.startsWith(oldPrefix + '/')) arr[i] = p.replace(oldPrefix, newPrefix); });
            };
            updatePath(openFiles, sourcePath, newPath);
            if (activeFile && (activeFile === sourcePath || activeFile.startsWith(sourcePath + '/'))) activeFile = activeFile.replace(sourcePath, newPath);
            
            const newExpanded = new Set();
            expandedFolders.forEach(p => {
                 if (p === sourcePath || p.startsWith(sourcePath + '/')) newExpanded.add(p.replace(sourcePath, newPath));
                 else newExpanded.add(p);
            });
            expandedFolders = newExpanded;

            renderFileExplorer();
            renderTabs();
        }

        async function downloadProjectAsZip() {
            statusBar.textContent = "Zipping project...";
            saveCurrentFile();
            const zip = new JSZip();
            function addFilesToZip(node, currentZipFolder) {
                for (const [name, child] of Object.entries(node)) {
                    if (child.type === 'file') {
                        currentZipFolder.file(name, child.content);
                    } else if (child.type === 'folder') {
                        addFilesToZip(child.children, currentZipFolder.folder(name));
                    }
                }
            }
            addFilesToZip(fileSystem, zip);
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "pyodide-project.zip";
            link.click();
            URL.revokeObjectURL(link.href);
            statusBar.textContent = "Pyodide: Ready";
        }
        
        function runActiveScript() {
            if (isExecuting || !isWorkerReady || !activeFile) return;
            saveCurrentFile();
            const node = getNodeFromPath(activeFile);
            if (node && node.type === 'file') {
                isExecuting = true;
                setInputsDisabled(true);
                statusBar.textContent = `Running ${activeFile}...`;
                term.write(`\r\n\x1b[1;33m--- Running ${activeFile} ---\x1b[0m`);
                worker.postMessage({ type: 'syncFS', payload: fileSystem });
                worker.postMessage({ type: 'script', payload: { path: activeFile, code: node.content } });
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => { renderFileExplorer(); renderTabs(); });
        document.getElementById('new-file-btn').addEventListener('click', () => showCreationInput('file'));
        document.getElementById('new-folder-btn').addEventListener('click', () => showCreationInput('folder'));
        document.getElementById('download-project-btn').addEventListener('click', downloadProjectAsZip);
        document.getElementById('run-script-btn').addEventListener('click', runActiveScript);
        document.getElementById('tab-run-btn').addEventListener('click', runActiveScript);
        document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveCurrentFile(); statusBar.textContent = `Saved ${activeFile}`; setTimeout(() => { if (!isExecuting) statusBar.textContent = "Pyodide: Ready"; }, 1500); }});
        
        fileExplorerDiv.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        fileExplorerDiv.addEventListener('dragenter', (e) => { if (e.target === fileExplorerDiv) fileExplorerDiv.classList.add('drag-over-root'); });
        fileExplorerDiv.addEventListener('dragleave', (e) => { if (e.target === fileExplorerDiv || !fileExplorerDiv.contains(e.relatedTarget)) fileExplorerDiv.classList.remove('drag-over-root'); });
        fileExplorerDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            fileExplorerDiv.classList.remove('drag-over-root');
            if (e.target === fileExplorerDiv) handleDrop(e, '');
        });

        const requirementsInput = document.getElementById('requirements-input');
        document.getElementById('upload-requirements-btn').addEventListener('click', () => requirementsInput.click());
        requirementsInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const contents = e.target.result;
                const packages = contents.split('\n').map(p => p.trim()).filter(p => p && !p.startsWith('#'));
                term.write(`\r\n\x1b[1;33m--- Installing from requirements.txt ---\x1b[0m`);
                packages.forEach(pkg => { if (pkg) worker.postMessage({ type: 'pip', payload: pkg }); });
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        const vResizer = document.getElementById('resizer'); const editorContainer = document.getElementById('editor-container'); let isVResizing = false;
        vResizer.addEventListener('mousedown', () => { isVResizing = true; });
        const hResizer = document.getElementById('sidebar-resizer'); const sidePanel = document.getElementById('side-panel'); let isHResizing = false;
        hResizer.addEventListener('mousedown', () => { isHResizing = true; });
        
        document.addEventListener('mousemove', (e) => { 
            if (isVResizing) { const newHeight = e.clientY - editorContainer.getBoundingClientRect().top; editorContainer.style.height = `${newHeight}px`; }
            if (isHResizing) { const newWidth = e.clientX - sidePanel.getBoundingClientRect().left; sidePanel.style.width = `${newWidth}px`; }
        }); 
        document.addEventListener('mouseup', () => { isVResizing = false; isHResizing = false; });
        document.getElementById('toggle-files-btn').addEventListener('click', () => { document.getElementById('side-panel').classList.toggle('hidden'); });

        const term = new Terminal({ cursorBlink: true, theme: { background: '#1e1e1e', foreground: '#cccccc' }, fontSize: 14 });
        const fitAddon = new FitAddon.FitAddon(); term.loadAddon(fitAddon); term.open(document.getElementById('terminal')); fitAddon.fit(); window.addEventListener('resize', () => fitAddon.fit());
        
        term.onData(e => { 
            if (isExecuting) return; 
            if (e === '\r') { 
                const command = currentCommand.trim();
                if (command) { 
                    term.write('\r\n'); 
                    isExecuting = true; 
                    setInputsDisabled(true); 
                    if (command.startsWith('pip install ')) {
                        const pkg = command.substring(12).trim();
                        statusBar.textContent = `Installing ${pkg}...`;
                        updatePackageButton(pkg, {isInstalling: true});
                        worker.postMessage({ type: 'pip', payload: pkg });
                    } else {
                        statusBar.textContent = "Running..."; 
                        worker.postMessage({ type: 'terminal', payload: command }); 
                    }
                } else { term.write(prompt); } 
                currentCommand = ''; 
            } else if (e === '\x7F') { 
                if (currentCommand) { term.write('\b \b'); currentCommand = currentCommand.slice(0, -1); } 
            } else { currentCommand += e; term.write(e); } 
        });

        worker.onmessage = (e) => { const { type, data, commandType, packageName, success } = e.data; switch (type) { case 'ready': isWorkerReady = true; setInputsDisabled(false); statusBar.textContent = "Pyodide: Ready"; term.write(prompt); break; case 'stdout': term.write('\r\n' + String(data).replace(/\n/g, '\r\n')); break; case 'stderr': term.write(`\r\n\x1b[1;31m${String(data).replace(/\n/g, '\r\n')}\x1b[0m`); break; case 'complete': isExecuting = false; if (commandType === 'pip' && packageName) { if (success) { installedPackages.add(packageName); updatePackageButton(packageName, {isInstalled: true}); } else { updatePackageButton(packageName, {isError: true}); } } setInputsDisabled(false); statusBar.textContent = "Pyodide: Ready"; term.write(prompt); break; } };
        
        // --- PACKAGE MANAGEMENT UI ---
        const PRESET_PACKAGES = ["numpy", "pandas", "matplotlib", "scikit-learn", "scipy", "seaborn", "statsmodels", "requests", "cowsay"];
        setInputsDisabled(true); const packageButtonsContainer = document.getElementById('package-buttons'); PRESET_PACKAGES.forEach(pkg => packageButtonsContainer.appendChild(createPackageButton(pkg)));
        document.getElementById('package-installer-container').addEventListener('click', (e) => { if (isExecuting || !isWorkerReady || !e.target.matches('.package-btn')) return; const packageName = e.target.dataset.package; if (e.target.disabled || installedPackages.has(packageName)) return; isExecuting = true; setInputsDisabled(true); statusBar.textContent = `Installing ${packageName}...`; updatePackageButton(packageName, {isInstalling: true}); worker.postMessage({ type: 'pip', payload: packageName }); });
        document.getElementById('pypi-search-input').addEventListener('keyup', e => e.key === 'Enter' && searchPyPI());
        function setInputsDisabled(disabled) { document.querySelectorAll('.package-btn, #pypi-search-input, #run-script-btn, #new-file-btn, #new-folder-btn, #upload-requirements-btn, #tab-run-btn').forEach(el => { if (!(el.matches('.package-btn') && installedPackages.has(el.dataset.package))) el.disabled = disabled; }); if (monacoEditor) monacoEditor.updateOptions({ readOnly: disabled }); }
        function createPackageButton(pkg) { const btn = document.createElement('button'); btn.className = "package-btn px-2 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded-md transition-colors"; btn.textContent = pkg; btn.dataset.package = pkg; return btn; }
        function updatePackageButton(packageName, {isInstalling = false, isInstalled = false, isError = false}) { const btn = document.querySelector(`[data-package="${packageName}"]`); if (!btn) return; if (isInstalling) { btn.textContent = "Installing..."; btn.disabled = true; } else if (isInstalled) { btn.textContent = `${packageName} ✓`; btn.classList.add('installed'); btn.disabled = true; } else if (isError) { btn.textContent = packageName; btn.disabled = false; btn.classList.remove('installed'); } }
        async function searchPyPI() { const searchInput = document.getElementById('pypi-search-input'); const query = searchInput.value.trim(); if (!query) return; const resultsContainer = document.getElementById('pypi-search-results'); resultsContainer.textContent = 'Searching...'; try { const response = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://pypi.org/search/?q=${query}`)}`); const html = await response.text(); const doc = new DOMParser().parseFromString(html, 'text/html'); const packages = [...doc.querySelectorAll('.package-snippet__name')].map(el => el.textContent.trim()); resultsContainer.innerHTML = ''; if (packages.length === 0) { resultsContainer.textContent = 'No results.'; return; } packages.slice(0, 10).forEach(pkg => { if (!document.querySelector(`[data-package="${pkg}"]`)) resultsContainer.appendChild(createPackageButton(pkg)); }); } catch (error) { resultsContainer.textContent = 'Search error.'; } }
    </script>
</body>
</html>

