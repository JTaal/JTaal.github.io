<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Vector Field Plotter (Div, Grad, Curl)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #030712;
            color: #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .ui-panel {
            background-color: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(55, 65, 81, 0.7);
        }
        header {
            position: relative;
            flex-shrink: 0;
            z-index: 20;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: rgba(3, 7, 18, 0.5);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(55, 65, 81, 0.7);
        }

        #app-container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            position: relative; /* Parent for absolute positioning */
        }

        #info-panel {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 420px;
            max-width: calc(100% - 2rem);
            max-height: calc(100% - 2rem);
            overflow-y: auto;
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.5s ease-in-out;
            cursor: pointer;
            z-index: 10;
        }
        
        #info-panel.collapsed {
            width: 280px;
            height: 58px;
            padding: 0;
            overflow: hidden;
        }
        
        #info-panel.collapsed #info-header {
             padding: 0.8rem 1.25rem;
        }

        #info-panel.collapsed #info-content {
            display: none;
        }

        #canvas-wrapper {
            flex: 1 1 auto;
            min-width: 0;
            position: relative;
        }

        #info-header { display: flex; justify-content: space-between; align-items: center; }
        #toggle-icon { transition: transform 0.3s ease-in-out; }
        #info-panel.collapsed #toggle-icon { transform: rotate(-90deg); }

        .formula-display {
            font-family: 'Courier New', monospace;
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            color: #d1d5db;
            border: 1px solid #374151;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }
        #controls-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            border-radius: 12px 12px 0 0;
            padding: 1rem 2rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            z-index: 10;
        }
        
        .menu-button, .action-button, select {
            background-color: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 500;
        }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2rem; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        .menu-button:hover, .action-button:hover, select:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }
        .menu-button.active, .action-button.active {
            background-color: #4f46e5;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.5);
        }
        .action-button.primary {
            background-color: #4f46e5;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #4b5563;
            border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #818cf8;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="text"] {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            padding: 0.25rem 0.5rem;
            font-family: 'Courier New', monospace;
        }
        input[type="color"] { width: 100%; height: 40px; border-radius: 8px; border: 1px solid #4b5563; }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .hidden { display: none !important; }
        canvas { 
            display: block; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #settings-button {
            position: absolute;
            background-color: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.9);
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            top: 1rem;
            right: 1rem;
            z-index: 11;
        }
        #settings-button:hover {
            background-color: #4338ca;
            transform: translateY(-2px) rotate(45deg);
        }
        #settings-panel {
            position: absolute;
            top: 1rem;
            right: 0;
            width: 300px;
            border-radius: 12px 0 0 12px;
            transform: translateX(100%);
            max-height: calc(100% - 2rem);
            overflow-y: auto;
            padding: 1.25rem;
            z-index: 12;
            transition: transform 0.5s ease-in-out;
        }
        #settings-panel.open {
            transform: translateX(0);
        }
        #close-settings { font-size: 2.5rem; line-height: 1; }
        hr { border-color: #374151; }

        .mobile-menu-item { display: block; width: 100%; text-align: left; padding: 10px 16px; }
        .mobile-menu-item.active { background-color: #4f46e5; font-weight: bold; }
        #mobile-menu-container { display: none; }
        
        @media (max-width: 1024px) {
            header { padding: 0.75rem 1rem; }
            header h1 { font-size: 1.125rem; }
            #menu { display: none !important; }
            #mobile-menu-container { display: block; }
            #controls-panel { flex-direction: column; padding: 0.75rem; gap: 0.75rem; }
            #info-panel.collapsed { width: 200px; }
        }
    </style>
</head>
<body>
    <header>
        <h1 class="text-xl font-bold text-gray-200 tracking-wider">3D Vector Field Plotter</h1>
        <div id="menu"></div>
        <div id="mobile-menu-container" class="relative">
            <button id="mobile-menu-button" class="menu-button">Menu</button>
            <div id="mobile-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 border rounded-md shadow-lg z-30"></div>
        </div>
    </header>

    <div id="app-container">
        <div id="canvas-wrapper">
             <div id="info-panel" class="ui-panel">
                <div id="info-header">
                    <h2 id="info-title" class="text-xl font-bold text-indigo-400">Welcome!</h2>
                    <div id="toggle-icon" class="text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                </div>
                <div id="info-content" class="pt-4 space-y-3">
                     <p id="info-description" class="text-gray-300"></p>
                     <div id="info-formula" class="formula-display"></div>
                </div>
            </div>
            <div id="controls-panel" class="ui-panel"></div>
            <button id="settings-button" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0 2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
            <div id="settings-panel" class="ui-panel hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Settings</h3>
                    <button id="close-settings" class="text-gray-400 hover:text-white">&times;</button>
                </div>
                <div class="space-y-6">
                    <h4 class="text-lg font-bold">Visualization</h4>
                    <div class="control-group text-left w-full">
                        <label for="grid-scale-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Grid Scale:</span> <span id="grid-scale-value">2.0</span>
                        </label>
                        <input id="grid-scale-slider" type="range" min="1" max="10" step="0.5" value="2" class="w-full">
                    </div>
                    <div class="control-group text-left w-full">
                        <label for="resolution-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Grid Resolution:</span> <span id="resolution-value">10</span>
                        </label>
                        <input id="resolution-slider" type="range" min="4" max="20" step="1" value="10" class="w-full">
                    </div>
                    <div class="control-group text-left w-full">
                        <label for="scale-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Arrow Scale:</span> <span id="scale-value">0.5</span>
                        </label>
                        <input id="scale-slider" type="range" min="0.1" max="2.0" step="0.05" value="0.5" class="w-full">
                    </div>
                     <div class="control-group text-left w-full">
                        <label class="text-sm font-medium self-start w-full">Show Bounding Box</label>
                        <button id="toggle-box-button" class="action-button w-full active">On</button>
                    </div>
                    <hr/>
                    <h4 class="text-lg font-bold">Camera Views</h4>
                    <div class="grid grid-cols-3 gap-2">
                        <button class="action-button" id="cam-top">Top</button>
                        <button class="action-button" id="cam-front">Front</button>
                        <button class="action-button" id="cam-side">Side</button>
                    </div>
                    <hr/>
                    <h4 class="text-lg font-bold">Color Settings</h4>
                    <div class="control-group text-left w-full">
                        <label for="grid-color-input" class="text-sm font-medium self-start">Grid Color</label>
                        <input id="grid-color-input" type="color" value="#888888">
                    </div>
                    <div class="control-group text-left w-full">
                        <label for="vector-color-mode" class="text-sm font-medium self-start">Vector Color Mode</label>
                        <select id="vector-color-mode" class="w-full">
                            <option value="magnitude">Magnitude</option>
                            <option value="analysis">Analysis</option>
                            <option value="solid">Solid</option>
                        </select>
                    </div>
                    <div id="solid-color-container" class="control-group text-left w-full hidden">
                        <label for="solid-vector-color" class="text-sm font-medium self-start">Solid Vector Color</label>
                        <input id="solid-vector-color" type="color" value="#ffffff">
                    </div>
                    <hr/>
                     <h4 class="text-lg font-bold">Slice Mode</h4>
                    <div class="control-group text-left w-full">
                        <label for="slice-axis-select" class="text-sm font-medium self-start">Slice Axis</label>
                        <select id="slice-axis-select" class="w-full">
                            <option value="off">Off</option>
                            <option value="x">X-Axis</option>
                            <option value="y">Y-Axis</option>
                            <option value="z">Z-Axis</option>
                        </select>
                    </div>
                     <div class="control-group text-left w-full">
                        <label for="slice-position-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Slice Position:</span> <span id="slice-position-value">0.00</span>
                        </label>
                        <input id="slice-position-slider" type="range" min="-1" max="1" step="0.01" value="0" class="w-full">
                    </div>
                     <div class="control-group text-left w-full">
                        <label for="slice-thickness-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Slice Thickness:</span> <span id="slice-thickness-value">0.10</span>
                        </label>
                        <input id="slice-thickness-slider" type="range" min="0.05" max="1.0" step="0.05" value="0.1" class="w-full">
                    </div>
                    <hr/>
                     <h4 class="text-lg font-bold">Particle Simulation</h4>
                     <div class="control-group text-left w-full">
                        <label class="text-sm font-medium self-start w-full">Show Particles</label>
                        <button id="toggle-particles-button" class="action-button w-full active">On</button>
                    </div>
                    <div class="control-group text-left w-full">
                        <label for="particle-count-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Particle Count:</span> <span id="particle-count-value">500</span>
                        </label>
                        <input id="particle-count-slider" type="range" min="0" max="2000" step="50" value="500" class="w-full">
                    </div>
                     <div class="control-group text-left w-full">
                        <label for="particle-speed-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Particle Speed:</span> <span id="particle-speed-value">0.50</span>
                        </label>
                        <input id="particle-speed-slider" type="range" min="0.1" max="2.0" step="0.05" value="0.5" class="w-full">
                    </div>
                    <div class="control-group text-left w-full">
                        <label for="particle-lifetime-slider" class="text-sm font-medium self-start flex justify-between w-full">
                            <span>Particle Lifetime (s):</span> <span id="particle-lifetime-value">4.0</span>
                        </label>
                        <input id="particle-lifetime-slider" type="range" min="1" max="10" step="0.5" value="4" class="w-full">
                    </div>
                    <button id="reset-particles-button" class="action-button w-full">Reset Particles</button>
                </div>
            </div>
        </div>
    </div>
    

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

    // --- Core Components ---
    let scene, camera, renderer, controls, gridHelper;
    let activeSceneObjects = new THREE.Group();
    let currentSceneKey = null;
    let boundingBoxHelper, sliceHelper;
    let currentFieldFunction = () => new THREE.Vector3();

    // --- Particle System ---
    let particleGroup = new THREE.Group();
    let particles = [];

    // --- Visualization Settings ---
    let settings = {
        gridScale: 2.0,
        resolution: 10,
        arrowScale: 0.5,
        showBox: true,
        gridColor: '#888888',
        vectorColorMode: 'magnitude',
        solidVectorColor: '#ffffff',
        sliceAxis: 'off',
        slicePosition: 0,
        sliceThickness: 0.1,
        showParticles: true,
        particleCount: 500,
        particleSpeed: 0.5,
        particleLifetime: 4.0,
    };

    // --- Scene & Preset Definitions ---
    const presets = {
        gradient: [
            { name: "Bowl", f: "x*x + y*y" },
            { name: "Saddle", f: "x*x - y*y" },
            { name: "Wave", f: "sin(x*2)*cos(y*2)" },
            { name: "Ripples", f: "sin(sqrt(x*x + y*y) * 5)"},
            { name: "Gaussian Bump", f: "exp(-(x*x + y*y))"},
            { name: "Multi-Wave", f: "sin(x) + cos(2*y) + sin(z)" },
            { name: "Exponential Decay", f: "exp(-0.5 * (x*x + y*y + z*z))" },
            { name: "Cellular", f: "cos(x*2) * sin(y*2) * exp(z/4)" },
            { name: "Inverse Square", f: "1 / (x*x + y*y + z*z + 0.1)" },
            { name: "XYZ Saddle", f: "x*y*z" },
            { name: "Paraboloid", f: "pow(x,2) + pow(y,2) - z" },
            { name: "Interference Pattern", f: "cos(x) * sin(y) + cos(y) * sin(z) + cos(z) * sin(x)"},
            { name: "Volcano", f: "exp(-(pow(sqrt(x*x+y*y)-1, 2))) - 0.5 * z*z" },
            { name: "Gyroidal", f: "sin(x)*cos(y) + sin(y)*cos(z) + sin(z)*cos(x)" },
            { name: "Double Bump", f: "exp(-pow(x-1,2) - y*y) + exp(-pow(x+1,2) - y*y)" },
            { name: "Inverted Pyramid", f: "abs(x)+abs(y)-abs(z)"}
        ],
        divergence: [
            { name: "Source", p: "x", q: "y", r: "z" },
            { name: "Sink", p: "-x", q: "-y", r: "-z" },
            { name: "2D Source (XY)", p: "x", q: "y", r: "0"},
            { name: "In/Out Flow", p: "sin(x)", q: "sin(y)", r: "sin(z)" },
            { name: "Shear Flow", p: "y", q: "0", r: "0"},
            { name: "Quadratic Source", p: "x*x", q: "y*y", r: "z*z" },
            { name: "Zero Div (Saddle)", p: "x", q: "-y", r: "0"},
            { name: "Zero Div (Rotation)", p: "y", q: "z", r: "x"},
            { name: "Alternating Flow", p: "sin(PI*x)", q: "cos(PI*y)", r: "z" },
            { name: "Localized Source", p: "x*exp(-(x*x+y*y))", q: "y*exp(-(x*x+y*y))", r: "0" },
            { name: "Singularity Field", p: "x/(x*x+0.1)", q: "y/(y*y+0.1)", r: "z/(z*z+0.1)" },
            { name: "Source & Sink", p: "(x-1)/((x-1)^2+y^2+z^2+0.1) - (x+1)/((x+1)^2+y^2+z^2+0.1)", q: "y/((x-1)^2+y^2+z^2+0.1) - y/((x+1)^2+y^2+z^2+0.1)", r: "z/((x-1)^2+y^2+z^2+0.1) - z/((x+1)^2+y^2+z^2+0.1)" },
            { name: "Dipole Field", p: "(3*x*z)/pow(x*x+z*z, 2.5)", q: "0", r: "(2*z*z - x*x)/pow(x*x+z*z, 2.5)"},
            { name: "Compression Flow", p: "x", q: "y", r: "-2*z" },
            { name: "Radial Decay", p: "x/sqrt(x*x+y*y+z*z+0.1)", q: "y/sqrt(x*x+y*y+z*z+0.1)", r: "z/sqrt(x*x+y*y+z*z+0.1)" }
        ],
        curl: [
            { name: "Whirlpool (Z-axis)", p: "-y", q: "x", r: "0" },
            { name: "Torus Flow", p: "-y * (1 - sqrt(x*x+y*y))", q: "x * (1 - sqrt(x*x+y*y))", r: "0"},
            { name: "Helix (Z-axis)", p: "-y", q: "x", r: "1"},
            { name: "Complex Swirl", p: "sin(z)", q: "sin(x)", r: "sin(y)" },
            { name: "Conical Swirl", p: "-y*z", q: "x*z", r: "0"},
            { name: "Double Vortex", p: "-y / (x*x + y*y + 0.1)", q: "x / (x*x + y*y + 0.1)", r: "0"},
            { name: "No Curl (Gradient)", p: "2*x", q: "2*y", r: "2*z"},
            { name: "Height-Varying Vortex", p: "y*cos(z)", q: "-x*cos(z)", r: "0" },
            { name: "Constant Curl", p: "z", q: "x", r: "y" },
            { name: "Quadratic Swirl", p: "y*y", q: "z*z", r: "x*x" },
            { name: "ABC Flow", p: "sin(z)+cos(y)", q: "sin(x)+cos(z)", r: "sin(y)+cos(x)" },
            { name: "Twisted Field", p: "sin(PI*y)", q: "sin(PI*z)", r: "sin(PI*x)"},
            { name: "Hopf Fibration", p: "2*(-y+x*z)", q: "2*(x+y*z)", r: "1-x*x-y*y+z*z"},
            { name: "Taylor-Green Vortex", p: "cos(x)*sin(y)", q: "-sin(x)*cos(y)", r: "0" },
            { name: "Accelerating Vortex", p: "-y*(x*x+y*y)", q: "x*(x*x+y*y)", r: "0" }
        ]
    };

    const scenes = {
        gradient: {
            title: 'Gradient ∇f',
            description: 'The gradient of a scalar field f(x,y,z) is a vector field that points in the direction of the greatest rate of increase of f. Its magnitude is the rate of increase.',
            formula: '∇f = (∂f/∂x)î + (∂f/∂y)ĵ + (∂f/∂z)k̂',
            init: setupGradientScene
        },
        divergence: {
            title: 'Divergence ∇·F',
            description: 'The divergence of a vector field F measures the magnitude of a source (positive div) or sink (negative div) at a given point. Colors indicate the value: red for sources, blue for sinks.',
            formula: '∇·F = ∂P/∂x + ∂Q/∂y + ∂R/∂z',
            init: setupDivergenceScene
        },
        curl: {
            title: 'Curl ∇×F',
            description: 'The curl of a vector field F measures the tendency to rotate at a point. The curl vector points along the axis of rotation, following the right-hand rule.',
            formula: '∇×F = (∂R/∂y - ∂Q/∂z)î + (∂P/∂z - ∂R/∂x)ĵ + (∂Q/∂x - ∂P/∂y)k̂',
            init: setupCurlScene
        }
    };
    
    // --- Math Calculation Helpers ---
    const h = 0.001; 

    function sanitizeFormula(str) {
        let s = str.replace(/\^/g, '**');
        const mathFuncs = ['sin', 'cos', 'tan', 'sqrt', 'pow', 'exp', 'log', 'abs', 'PI'];
        mathFuncs.forEach(f => {
            const regex = new RegExp(`\\b${f}\\b`, 'g');
            s = s.replace(regex, `Math.${f}`);
        });
        return s;
    }
    
    function createScalarFunction(fStr) {
        try { return new Function('x', 'y', 'z', `return ${sanitizeFormula(fStr)}`); } 
        catch (e) { console.error("Invalid scalar function:", e); return () => 0; }
    }

    function createVectorFunction(pStr, qStr, rStr) {
        try {
            const pFunc = new Function('x', 'y', 'z', `return ${sanitizeFormula(pStr)}`);
            const qFunc = new Function('x', 'y', 'z', `return ${sanitizeFormula(qStr)}`);
            const rFunc = new Function('x', 'y', 'z', `return ${sanitizeFormula(rStr)}`);
            return (x, y, z) => new THREE.Vector3(pFunc(x, y, z), qFunc(x, y, z), rFunc(x, y, z));
        } catch (e) { console.error("Invalid vector function:", e); return () => new THREE.Vector3(); }
    }

    function calculateGradient(scalarFunc, x, y, z) {
        const dfdx = (scalarFunc(x + h, y, z) - scalarFunc(x - h, y, z)) / (2 * h);
        const dfdy = (scalarFunc(x, y + h, z) - scalarFunc(x, y - h, z)) / (2 * h);
        const dfdz = (scalarFunc(x, y, z + h) - scalarFunc(x, y, z - h)) / (2 * h);
        return new THREE.Vector3(dfdx, dfdy, dfdz);
    }

    function calculateDivergence(vectorFunc, x, y, z) {
        const dPdx = (vectorFunc(x + h, y, z).x - vectorFunc(x - h, y, z).x) / (2 * h);
        const dQdy = (vectorFunc(x, y + h, z).y - vectorFunc(x, y - h, z).y) / (2 * h);
        const dRdz = (vectorFunc(x, y, z + h).z - vectorFunc(x, y, z - h).z) / (2 * h);
        return dPdx + dQdy + dRdz;
    }

    function calculateCurl(vectorFunc, x, y, z) {
        const dRdy = (vectorFunc(x, y + h, z).z - vectorFunc(x, y - h, z).z) / (2 * h);
        const dQdz = (vectorFunc(x, y, z + h).y - vectorFunc(x, y, z - h).y) / (2 * h);
        const dPdz = (vectorFunc(x, y, z + h).x - vectorFunc(x, y, z - h).x) / (2 * h);
        const dRdx = (vectorFunc(x + h, y, z).z - vectorFunc(x - h, y, z).z) / (2 * h);
        const dQdx = (vectorFunc(x + h, y, z).y - vectorFunc(x - h, y, z).y) / (2 * h);
        const dPdy = (vectorFunc(x, y + h, z).x - vectorFunc(x, y - h, z).x) / (2 * h);
        return new THREE.Vector3(dRdy - dQdz, dPdz - dRdx, dQdx - dPdy);
    }

    // --- Scene Setup Functions ---
    function setupGradientScene() {
        let controlsHtml = `
            <div class="flex items-center gap-2">
                <label for="scalar-f" class="font-bold text-lg">f(x,y,z) =</label>
                <input id="scalar-f" type="text" value="x*x + y*y" class="w-48">
            </div>`;
        controlsHtml += createPresetDropdown(presets.gradient, (p) => `document.getElementById('scalar-f').value = '${p.f}';`);
        controlsHtml += `<button id="plot-btn" class="action-button primary">Plot Field</button>`;
        document.getElementById('controls-panel').innerHTML = controlsHtml;
        
        const plot = () => {
            const scalarFunc = createScalarFunction(document.getElementById('scalar-f').value);
            plotVectorField((x, y, z) => calculateGradient(scalarFunc, x, y, z));
        };
        document.getElementById('plot-btn').onclick = plot;
        document.getElementById('presets-select')?.addEventListener('change', (e) => { eval(e.target.value); plot(); });
        plot();
    }

    function setupDivergenceScene() {
        let controlsHtml = `
            <div class="flex flex-col md:flex-row items-center gap-4">
                <span class="font-bold text-lg">F(x,y,z) =</span>
                <div class="flex items-center gap-2"><input id="vec-p" type="text" value="x" class="w-20">î</div>
                <div class="flex items-center gap-2">+ <input id="vec-q" type="text" value="y" class="w-20">ĵ</div>
                <div class="flex items-center gap-2">+ <input id="vec-r" type="text" value="z" class="w-20">k̂</div>
            </div>`;
        controlsHtml += createPresetDropdown(presets.divergence, (p) => `document.getElementById('vec-p').value = '${p.p}'; document.getElementById('vec-q').value = '${p.q}'; document.getElementById('vec-r').value = '${p.r}';`);
        controlsHtml += `<button id="plot-btn" class="action-button primary">Plot Field</button>`;
        document.getElementById('controls-panel').innerHTML = controlsHtml;

        const plot = () => {
            const vecFunc = createVectorFunction(document.getElementById('vec-p').value, document.getElementById('vec-q').value, document.getElementById('vec-r').value);
            plotVectorField(vecFunc, (x,y,z) => calculateDivergence(vecFunc, x, y, z));
        };
        document.getElementById('plot-btn').onclick = plot;
        document.getElementById('presets-select')?.addEventListener('change', (e) => { eval(e.target.value); plot(); });
        plot();
    }
    
    function setupCurlScene() {
        let controlsHtml = `
            <div class="flex flex-col md:flex-row items-center gap-4">
                <span class="font-bold text-lg">F(x,y,z) =</span>
                <div class="flex items-center gap-2"><input id="vec-p" type="text" value="-y" class="w-20">î</div>
                <div class="flex items-center gap-2">+ <input id="vec-q" type="text" value="x" class="w-20">ĵ</div>
                <div class="flex items-center gap-2">+ <input id="vec-r" type="text" value="0" class="w-20">k̂</div>
            </div>`;
        controlsHtml += createPresetDropdown(presets.curl, (p) => `document.getElementById('vec-p').value = '${p.p}'; document.getElementById('vec-q').value = '${p.q}'; document.getElementById('vec-r').value = '${p.r}';`);
        controlsHtml += `<button id="plot-btn" class="action-button primary">Plot Field</button>`;
        document.getElementById('controls-panel').innerHTML = controlsHtml;
        
        const plot = () => {
            const vecFunc = createVectorFunction(document.getElementById('vec-p').value, document.getElementById('vec-q').value, document.getElementById('vec-r').value);
            plotVectorField((x, y, z) => calculateCurl(vecFunc, x, y, z));
        };
        document.getElementById('plot-btn').onclick = plot;
        document.getElementById('presets-select')?.addEventListener('change', (e) => { eval(e.target.value); plot(); });
        plot();
    }
    
    function createPresetDropdown(presetList, valueGenerator) {
        if (!presetList || presetList.length === 0) return '';
        let options = presetList.map(p => `<option value="${valueGenerator(p)}">${p.name}</option>`).join('');
        return `<select id="presets-select" class="action-button"><option value="">-- Presets --</option>${options}</select>`;
    }

    // --- Core Plotting Logic ---
    function plotVectorField(fieldFunc, colorFunc = null) {
        currentFieldFunction = fieldFunc;
        clearVectorField();
        const fieldGroup = new THREE.Group();
        const step = (2 * settings.gridScale) / (settings.resolution - 1);
        
        let minVal = Infinity, maxVal = -Infinity;
        const gridPoints = [];

        for (let i = 0; i < settings.resolution; i++) {
            for (let j = 0; j < settings.resolution; j++) {
                for (let k = 0; k < settings.resolution; k++) {
                    const x = -settings.gridScale + i * step;
                    const y = -settings.gridScale + j * step;
                    const z = -settings.gridScale + k * step;
                    
                    if (settings.sliceAxis !== 'off') {
                        const axisPos = {x, y, z}[settings.sliceAxis];
                        const scaledSlicePos = settings.slicePosition * settings.gridScale;
                        if (Math.abs(axisPos - scaledSlicePos) > settings.sliceThickness / 2) continue;
                    }
                    const vec = fieldFunc(x, y, z);
                    let val;
                    if (settings.vectorColorMode === 'analysis' && colorFunc) val = colorFunc(x, y, z);
                    else if (settings.vectorColorMode === 'magnitude') val = vec.length();
                    if (val !== undefined) {
                        minVal = Math.min(minVal, val);
                        maxVal = Math.max(maxVal, val);
                    }
                    gridPoints.push({x, y, z, vec});
                }
            }
        }
        
        const valRange = settings.vectorColorMode === 'analysis' ? Math.max(Math.abs(minVal), Math.abs(maxVal)) : maxVal - minVal;

        gridPoints.forEach(p => {
            const {x, y, z, vec} = p;
            const length = vec.length();
            if (length > 0.001) {
                let color;
                if (settings.vectorColorMode === 'solid') {
                    color = new THREE.Color(settings.solidVectorColor).getHex();
                } else if (settings.vectorColorMode === 'magnitude') {
                    const t = valRange > 0.001 ? (length - minVal) / valRange : 0.5;
                    color = new THREE.Color().setHSL(0.7 - t * 0.7, 1.0, 0.5).getHex();
                } else if (settings.vectorColorMode === 'analysis' && colorFunc) {
                    const val = colorFunc(x, y, z);
                    const t = valRange > 0.001 ? (val / valRange + 1) / 2 : 0.5;
                    color = new THREE.Color().lerpColors(new THREE.Color(0x0000ff), new THREE.Color(0xff0000), t).getHex();
                } else {
                    color = 0xffffff;
                }
                const dir = vec.clone().normalize();
                const arrow = new THREE.ArrowHelper(dir, new THREE.Vector3(x,y,z), length * settings.arrowScale, color, 0.1 * settings.arrowScale, 0.15 * settings.arrowScale);
                fieldGroup.add(arrow);
            }
        });
        activeSceneObjects.add(fieldGroup);
        resetParticles();
    }

    function clearVectorField() {
        while (activeSceneObjects.children.length > 0) activeSceneObjects.remove(activeSceneObjects.children[0]);
    }

    // --- Particle System Logic ---
    const particleGeometry = new THREE.SphereGeometry(0.03, 8, 8);
    const particleMaterial = new THREE.MeshBasicMaterial({ color: 0xfff700 });

    function resetParticles() {
        while (particleGroup.children.length > 0) particleGroup.remove(particleGroup.children[0]);
        particles = [];
        for (let i = 0; i < settings.particleCount; i++) {
            const particleMesh = new THREE.Mesh(particleGeometry, particleMaterial);
            const pos = new THREE.Vector3(
                (Math.random() - 0.5) * 2 * settings.gridScale,
                (Math.random() - 0.5) * 2 * settings.gridScale,
                (Math.random() - 0.5) * 2 * settings.gridScale
            );
            particleMesh.position.copy(pos);
            particles.push({ mesh: particleMesh, age: Math.random() * settings.particleLifetime });
            particleGroup.add(particleMesh);
        }
        particleGroup.visible = settings.showParticles;
    }

    function updateParticles(delta) {
        if (!settings.showParticles || settings.particleCount === 0) {
            particleGroup.visible = false;
            return;
        }
        particleGroup.visible = true;

        particles.forEach(p => {
            p.age += delta;
            if (p.age > settings.particleLifetime) {
                p.age = 0;
                p.mesh.position.set(
                    (Math.random() - 0.5) * 2 * settings.gridScale,
                    (Math.random() - 0.5) * 2 * settings.gridScale,
                    (Math.random() - 0.5) * 2 * settings.gridScale
                );
            }
            const fieldVec = currentFieldFunction(p.mesh.position.x, p.mesh.position.y, p.mesh.position.z);
            p.mesh.position.addScaledVector(fieldVec, delta * settings.particleSpeed);

            if (Math.abs(p.mesh.position.x) > settings.gridScale || Math.abs(p.mesh.position.y) > settings.gridScale || Math.abs(p.mesh.position.z) > settings.gridScale) {
                p.age = settings.particleLifetime; 
            }
        });
    }

    // --- Initialization and Scene Management ---
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('canvas-wrapper').appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        scene.add(new THREE.AmbientLight(0xcccccc));
        scene.add(new THREE.DirectionalLight(0xffffff, 0.5));
        
        boundingBoxHelper = new THREE.LineSegments(
            new THREE.EdgesGeometry(new THREE.BoxGeometry(1, 1, 1)),
            new THREE.LineBasicMaterial({color: 0x888888})
        );
        scene.add(boundingBoxHelper);
        
        sliceHelper = new THREE.Mesh( 
            new THREE.PlaneGeometry(1, 1), 
            new THREE.MeshBasicMaterial({color: 0x4f46e5, side: THREE.DoubleSide, transparent: true, opacity: 0.2}) 
        );
        scene.add(sliceHelper);
        
        updateSceneScale();
        
        scene.add(activeSceneObjects);
        scene.add(particleGroup);

        createMenu();
        setupUI();
        switchScene('gradient'); // Default to gradient
        window.addEventListener('resize', onWindowResize, false);
        onWindowResize();
        renderer.setAnimationLoop(animate);
    }
    
    function updateSceneScale() {
        const scale = settings.gridScale;
        camera.position.set(1.5 * scale, 1.5 * scale, 2.5 * scale);
        controls.target.set(0,0,0);
        
        if (gridHelper) scene.remove(gridHelper);
        gridHelper = new THREE.GridHelper(scale * 2, settings.resolution - 1);
        gridHelper.material.opacity = 0.25;
        gridHelper.material.transparent = true;
        gridHelper.material.color.set(settings.gridColor);
        scene.add(gridHelper);
        
        boundingBoxHelper.scale.set(scale * 2, scale * 2, scale * 2);
        sliceHelper.scale.set(scale * 2, scale * 2, 1);
        
        updateSliceHelper();
    }

    function switchScene(key) {
        if (key === currentSceneKey) return;
        currentSceneKey = key;

        const sceneData = scenes[key];
        document.getElementById('info-title').textContent = sceneData.title;
        document.getElementById('info-description').textContent = sceneData.description;
        document.getElementById('info-formula').textContent = sceneData.formula;
        
        document.querySelectorAll('#menu .menu-button, #mobile-menu-dropdown .mobile-menu-item').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.key === key) el.classList.add('active');
        });
        document.getElementById('mobile-menu-button').textContent = sceneData.title;
        
        sceneData.init();
    }

    // --- UI Setup ---
    function createMenu() {
        const menuDiv = document.getElementById('menu');
        const mobileMenuDropdown = document.getElementById('mobile-menu-dropdown');
        Object.keys(scenes).forEach(key => {
            const sceneTitle = scenes[key].title;
            const desktopButton = document.createElement('button');
            desktopButton.dataset.key = key;
            desktopButton.className = 'menu-button';
            desktopButton.textContent = sceneTitle;
            desktopButton.onclick = () => switchScene(key);
            menuDiv.appendChild(desktopButton);
            
            const mobileButton = document.createElement('button');
            mobileButton.dataset.key = key;
            mobileButton.className = 'mobile-menu-item text-white';
            mobileButton.textContent = sceneTitle;
            mobileButton.onclick = () => { switchScene(key); mobileMenuDropdown.classList.add('hidden'); };
            mobileMenuDropdown.appendChild(mobileButton);
        });
    }

    function updateSliceHelper() {
        const scale = settings.gridScale;
        sliceHelper.visible = settings.sliceAxis !== 'off';
        if (settings.sliceAxis === 'off') return;
        
        sliceHelper.position.set(0,0,0);
        sliceHelper.rotation.set(0,0,0);
        
        const scaledSlicePos = settings.slicePosition * scale;

        if (settings.sliceAxis === 'x') { sliceHelper.rotation.y = Math.PI / 2; sliceHelper.position.x = scaledSlicePos; } 
        else if (settings.sliceAxis === 'y') { sliceHelper.rotation.x = Math.PI / 2; sliceHelper.position.y = scaledSlicePos; } 
        else if (settings.sliceAxis === 'z') { sliceHelper.position.z = scaledSlicePos; }
    }
    
    function setupUI() {
        document.getElementById('info-header').addEventListener('click', (e) => {
             const infoPanel = document.getElementById('info-panel');
             infoPanel.classList.toggle('collapsed');
             setTimeout(onWindowResize, 50);
        });
        const menuButton = document.getElementById('mobile-menu-button');
        const dropdown = document.getElementById('mobile-menu-dropdown');
        menuButton.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('hidden'); });
        window.addEventListener('click', () => dropdown.classList.add('hidden'));

        const settingsPanel = document.getElementById('settings-panel');
        document.getElementById('settings-button').addEventListener('click', () => { 
            settingsPanel.classList.remove('hidden'); 
            requestAnimationFrame(() => settingsPanel.classList.add('open')); 
        });
        document.getElementById('close-settings').addEventListener('click', () => settingsPanel.classList.remove('open'));
        settingsPanel.addEventListener('transitionend', () => { if (!settingsPanel.classList.contains('open')) settingsPanel.classList.add('hidden'); });
        
        // --- Settings Controls ---
        document.getElementById('grid-scale-slider').addEventListener('input', (e) => {
            settings.gridScale = parseFloat(e.target.value);
            document.getElementById('grid-scale-value').textContent = settings.gridScale.toFixed(1);
            updateSceneScale();
        });
        document.getElementById('grid-scale-slider').addEventListener('change', () => scenes[currentSceneKey].init());

        document.getElementById('resolution-slider').addEventListener('input', (e) => {
            settings.resolution = parseInt(e.target.value);
            document.getElementById('resolution-value').textContent = settings.resolution;
        });
        document.getElementById('resolution-slider').addEventListener('change', () => {
            updateSceneScale(); scenes[currentSceneKey].init();
        });

        document.getElementById('scale-slider').addEventListener('input', (e) => {
            settings.arrowScale = parseFloat(e.target.value);
            document.getElementById('scale-value').textContent = settings.arrowScale.toFixed(2);
            scenes[currentSceneKey].init();
        });

        document.getElementById('toggle-box-button').addEventListener('click', (e) => {
            settings.showBox = !settings.showBox;
            boundingBoxHelper.visible = settings.showBox;
            e.target.textContent = settings.showBox ? 'On' : 'Off';
            e.target.classList.toggle('active', settings.showBox);
        });

        const s = () => settings.gridScale;
        document.getElementById('cam-top').addEventListener('click', () => { camera.position.set(0, s() * 2.5, 0.01); controls.target.set(0,0,0); });
        document.getElementById('cam-front').addEventListener('click', () => { camera.position.set(0, 0, s() * 2.5); controls.target.set(0,0,0); });
        document.getElementById('cam-side').addEventListener('click', () => { camera.position.set(s() * 2.5, 0, 0); controls.target.set(0,0,0); });

        document.getElementById('grid-color-input').addEventListener('input', (e) => {
            settings.gridColor = e.target.value;
            gridHelper.material.color.set(settings.gridColor);
            boundingBoxHelper.material.color.set(settings.gridColor);
        });
        
        const colorModeSelect = document.getElementById('vector-color-mode');
        const solidColorContainer = document.getElementById('solid-color-container');
        colorModeSelect.addEventListener('change', (e) => {
            settings.vectorColorMode = e.target.value;
            solidColorContainer.classList.toggle('hidden', settings.vectorColorMode !== 'solid');
            scenes[currentSceneKey].init();
        });
        
        document.getElementById('solid-vector-color').addEventListener('input', (e) => {
            settings.solidVectorColor = e.target.value;
            if (settings.vectorColorMode === 'solid') scenes[currentSceneKey].init();
        });
        
        document.getElementById('slice-axis-select').addEventListener('change', (e) => {
            settings.sliceAxis = e.target.value;
            updateSliceHelper();
            scenes[currentSceneKey].init();
        });
        
        const slicePosSlider = document.getElementById('slice-position-slider');
        slicePosSlider.addEventListener('input', (e) => {
            settings.slicePosition = parseFloat(e.target.value);
            document.getElementById('slice-position-value').textContent = (settings.slicePosition * settings.gridScale).toFixed(2);
            updateSliceHelper();
            scenes[currentSceneKey].init();
        });
        slicePosSlider.min = -1; slicePosSlider.max = 1; slicePosSlider.step = 0.01;

        document.getElementById('slice-thickness-slider').addEventListener('input', (e) => {
            settings.sliceThickness = parseFloat(e.target.value);
            document.getElementById('slice-thickness-value').textContent = settings.sliceThickness.toFixed(2);
            scenes[currentSceneKey].init();
        });

        // Particle controls
        document.getElementById('toggle-particles-button').addEventListener('click', (e) => {
            settings.showParticles = !settings.showParticles;
            particleGroup.visible = settings.showParticles;
            e.target.textContent = settings.showParticles ? 'On' : 'Off';
            e.target.classList.toggle('active', settings.showParticles);
        });
        document.getElementById('particle-count-slider').addEventListener('input', (e) => {
            settings.particleCount = parseInt(e.target.value, 10);
            document.getElementById('particle-count-value').textContent = settings.particleCount;
            if (settings.particleCount > particles.length) resetParticles();
        });
        document.getElementById('particle-count-slider').addEventListener('change', resetParticles);
        
        document.getElementById('particle-speed-slider').addEventListener('input', (e) => {
            settings.particleSpeed = parseFloat(e.target.value);
            document.getElementById('particle-speed-value').textContent = settings.particleSpeed.toFixed(2);
        });
        document.getElementById('particle-lifetime-slider').addEventListener('input', (e) => {
            settings.particleLifetime = parseFloat(e.target.value);
            document.getElementById('particle-lifetime-value').textContent = settings.particleLifetime.toFixed(1);
        });
        document.getElementById('reset-particles-button').addEventListener('click', resetParticles);
    }

    // --- Main Loop and Resize ---
    function onWindowResize() {
        const wrapper = document.getElementById('canvas-wrapper');
        if (!wrapper) return;
        
        const width = wrapper.clientWidth;
        const height = wrapper.clientHeight;
        
        if (width === 0 || height === 0) return;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
    }

    function animate(time) {
        const delta = 1/60; 
        controls.update();
        updateParticles(delta);
        renderer.render(scene, camera);
    }

    init();
</script>
</body>
</html>

